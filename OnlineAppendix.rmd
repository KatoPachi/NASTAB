---
title: |
  Online Appendix
  "Tax-Price Elasticities of Charitable Giving and Selection of Declaration:
  Panel Study of South Korea"
author:
  - Hiroki Kato
  - Tsuyoshi Goto
  - Youngrok Kim
output:
  bookdown::pdf_document2:
    latex_engine: pdflatex
    keep_tex: false
    toc: false
    extra_dependencies: ["here"]
base-strech: 1.5
fontsize: 12pt
---

```{r include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  error = FALSE,
  message = FALSE,
  dev = "pdf",
  fig.pos = "H",
  fig.width = 10,
  fig.height = 5,
  out.extra = ""
)

options(
  knitr.table.format = "latex",
  knitr.kable.NA = "",
  modelsummary_stars_note = FALSE,
  modelsummary_factory_default = "latex"
)
```

# Tables and Figures

\listoffigures
\listoftables
\clearpage

```{r library, include=FALSE}
library(here)
source(here("R/R6_StartAnalysis.r"))
```

```{r data, include=FALSE}
rawdt <- read_csv(here("data/shaped2.csv")) %>%
  employee() %>%
  donut_hole() %>%
  log_inc()

dt <- rawdt %>%
  remove_highest_bracket() %>%
  set_donate_bound()
```

```{r summary-class, include=FALSE}
main <- StartAnalysis$new(dt)
data_summary <- main$summary()
```

```{r table2}
data_summary$stats(
  title = "Descriptive Statistics (Wage Earner Only)",
  label = "summary-covariate",
  notes = "Notes: Our data is unbalanced panel data consisting of 8,441 unique individuals and 8 years period (2010--2017). The number of dependents in household do not include the number of children."
)
```

```{r figure1, fig.cap="Income Distribution in 2013 and Relative Giving Price (Wage Earner Only)"}
data_summary$income_dist()
```

```{r figure2, fig.cap = "Average Givine Amount and Proportion of Donors (Wage Earner Only)"}
data_summary$ts_giving()
```

```{r figure3, fig.cap = "Proportion Having Applied for Tax Incentives (Wage Earner Only)"}
data_summary$ts_claim()
```

```{r figureA1, fig.cap = "Proportion Having Applied for Tax Incentives (Wage Earner Only)"}
data_summary$ts_claim(d_donate == 1)
```

```{r first-price-class, include=FALSE}
fp_main <- main$first_price()
```

```{r tableA1}
fp_main$stage1(
  title = "First-Stage Models",
  label = "main-stage1",
  notes = "Notes: * $p < 0.1$, ** $p < 0.05$, *** $p < 0.01$. Standard errors clustered at household level are in parentheses. We only use wage earners. The outcome variable is the logged value of the effective price. In addition to logged income shown in table, covariates consist of squared age (divided by 100), number of household members, number of children, number of dependents, a dummy that indicates the highest income in a household, a dummy that indicates that a taxpayer is household head, a dummy that indicates a wage earner, a set of industry dummies, a set of residential area dummies, and individual and time fixed effects. The excluded instrument is the logged applicable price."
)
```

```{r table3}
fp_main$stage2(
  title = "Estimation Results of First-Price Elasticities",
  label = "main",
  notes = "Notes: * $p < 0.1$, ** $p < 0.05$, *** $p < 0.01$. Standard errors clustered at the household level are in parentheses. We only use wage earners. In column (1)--(3), an outcome variable is the logged value of donation. We first normalize an amount of donation so that 1 corresponds to the value of the minimum nonzero donation in the data (2,000KRW). Then, we then transform an amount of donation to $m(g)$, where $m(y) = \\\\log(y)$ for $y > 0$ and $m(0) = -1$. In column (4)--(6), an outcome variable is an indicator of donor. In addition to logged income, covariates consist of squared age (divided by 100), number of household members, number of children, number of dependents, a dummy that indicates the highest income in a household, a dummy that indicates that a taxpayer is household head, a set of industry dummies, a set of residential area dummies, and individual and time fixed effects. The excluded instrument is a logged applicable price in columns (3) and (6). To obtain the extensive-margin price elasticities in columns (4)--(6), we calculate implied price elasticities by dividing the estimated coefficient on price by the sample proportion of donors."
)
```

```{r last-price-class, include=FALSE}
lp <- main$last_price()
```

```{r tableD1}
lp$overall(
  title = "Last-Price Elasticities for Overall Donations",
  label = "last-int",
  notes = "Notes: * $p < 0.1$, ** $p < 0.05$, *** $p < 0.01$. Standard errors clustered at the household level are in parenthesis. We use only wage earners. The outcome variable is the logged value of donation. We first normalize an amount of donation so that 1 corresponds to the value of the minimum nonzero donation in the data (2,000KRW). Then, we then transform an amount of donation to $m(g)$, where $m(y) = \\\\log(y)$ for $y > 0$ and $m(0) = -1$. In addition to logged income, covariates consist of squared age (divided by 100), number of household members, number of children, number of dependents, a dummy that indicates the highest income in a household, a dummy that indicates that a taxpayer is household head, a set of industry dummies, a set of residential area dummies, and individual and time fixed effects. For FE-2SLS, we use the logged applicable first price as an instrument."
)
```

```{r tableD2}
lp$extensive(
  title = "Last-Price Elasticities for Extensive-Margin",
  label = "last-ext",
  notes = "Notes: * $p < 0.1$, ** $p < 0.05$, *** $p < 0.01$. Standard errors clustered at the household level are in parentheses. We use only wage earners. The outcome variable is a dummy indicating a donor. In addition to logged income, covariates consist of squared age (divided by 100), number of household members, number of children, number of dependents, a dummy that indicates the highest income in a household, a dummy that indicates that a taxpayer is household head, a set of industry dummies, a set of residential area dummies, and individual and time fixed effects. For FE-2SLS, we use the logged applicable first price as an instrument. We calculate implied price elasticities by dividing the estimated coefficient on price by the sample proportion of donors."
)
```

```{r remove-bracket-shift}
dt2 <- rawdt %>%
  remove_bracket_shift() %>%
  set_donate_bound()

fp_robust1 <- StartAnalysis$new(dt2)$first_price()
```

```{r tableD3}
fp_robust1$stage2(
  title = "First-Price Elasticities Removing Price Variation in Income Deduction Period",
  label = "remove-bracket-shift",
  notes = "Notes: * $p < 0.1$, ** $p < 0.05$, *** $p < 0.01$. Standard errors clustered at the household level are in parentheses. We use only wage earners. We exclude those whose prices changed during the income deduction period. In column (1)--(3), an outcome variable is the logged value of donation. We first normalize an amount of donation so that 1 corresponds to the value of the minimum nonzero donation in the data (2,000KRW). Then, we then transform an amount of donation to $m(g)$, where $m(y) = \\\\log(y)$ for $y > 0$ and $m(0) = -1$. In column (4)--(6), an outcome variable is an indicator of donor. In addition to logged income, covariates consist of squared age (divided by 100), number of household members, number of children, number of dependents, a dummy that indicates the highest income in a household, a dummy that indicates that a taxpayer is household head, a set of industry dummies, a set of residential area dummies, and individual and time fixed effects. The excluded instrument is a logged applicable price in columns (3) and (6). To obtain the extensive-margin price elasticities in columns (4)--(6), we calculate implied price elasticities by dividing the estimated coefficient on price by the sample proportion of donors."
)
```

```{r exclude-announcement-effect}
dt3 <- dt %>%
  remove_around_reform()

fp_robust2 <- StartAnalysis$new(dt3)$first_price()
```

```{r tableD4}
fp_robust2$stage2(
  title = "First-Price Elasticities Excluding Announcement Effect",
  label = "announcement",
  notes = "Notes: * $p < 0.1$, ** $p < 0.05$, *** $p < 0.01$. Standard errors clustered at the household level are in parentheses. We use only wage earners. To exclude the announcement effect, we exclude observations from 2013 and 2014. In column (1)--(3), an outcome variable is the logged value of donation. We first normalize an amount of donation so that 1 corresponds to the value of the minimum nonzero donation in the data (2,000KRW). Then, we then transform an amount of donation to $m(g)$, where $m(y) = \\\\log(y)$ for $y > 0$ and $m(0) = -1$. In column (4)--(6), an outcome variable is an indicator of donor. In addition to logged income, covariates consist of squared age (divided by 100), number of household members, number of children, number of dependents, a dummy that indicates the highest income in a household, a dummy that indicates that a taxpayer is household head, a set of industry dummies, a set of residential area dummies, and individual and time fixed effects. The excluded instrument is a logged applicable price in columns (3) and (6). To obtain the extensive-margin price elasticities in columns (4)--(6), we calculate implied price elasticities by dividing the estimated coefficient on price by the sample proportion of donors."
)
```

```{r tableD5}
fp_main$claimant_only(
  title = "First-Price Elasticities of Reported Donations",
  label = "claimant-only",
  notes = "Notes: * $p < 0.1$, ** $p < 0.05$, *** $p < 0.01$. Standard errors clustered at the household level are in parentheses. We use only wage earners. the logged value of reported donation. The reported donation is defined by the product of an indicator of report and an amount of donation. We first normalize an amount of reported donation so that 1 corresponds to the value of the minimum nonzero donation in the data (2,000KRW). Then, we then transform an amount of donation to $m(g)$, where $m(y) = \\\\log(y)$ for $y > 0$ and $m(0) = -1$. In addition to logged income, covariates consist of squared age (divided by 100), number of household members, number of children, number of dependents, a dummy that indicates the highest income in a household, a dummy that indicates that a taxpayer is household head, a set of industry dummies, a set of residential area dummies, and individual and time fixed effects."
)
```

```{r tableD6}
fp_main$claim_elasticity(
  title = "First-Price Elasticity of Declaration",
  label = "claim-elasticity",
  notes = "Notes: * $p < 0.1$, ** $p < 0.05$, *** $p < 0.01$. Standard errors clustered at the household level are in parentheses. We use only wage earners. The outcome variable is a dummy of report. In addition to logged income, covariates consist of squared age (divided by 100), number of household members, number of children, number of dependents, a dummy that indicates the highest income in a household, a dummy that indicates that a taxpayer is household head, a set of industry dummies, a set of residential area dummies, and individual and time fixed effects. To obtain the price elasticity, we calculate implied price elasticities by dividing the estimated coefficient on price by the sample proportion of claimants."
)
```

```{r policy-effect-class, include=FALSE}
policy <- main$policy_effect()
```

```{r table4}
policy$effective(
  e = -4.188,
  title = "Policy Effect of 2014 Tax Reform",
  label = "policy-effect",
  notes = "Notes: We use wage earners whose status of report is observed for 2013 and 2014. Column (1) shows the sample size by income bracket for 2013. Columns (2) and (3) are the report rates for each year. Columns (4) and (5) are the average effective price for each year. Column (6) reports the percentage change in the effective price. Columns (7) shows the average contribution in 2013. Column (8) shows the percentage change in contributions, which is the product of the value in Column (6) and the overall effective price elasticity ($-4.188$). Columns (2)--(8) divide the sample by income bracket, reporting status in 2013, and reporting status in 2014, calculate the corresponding indicator in each subset, and then calculate the average of each indicator weighted by the subset sample size in each income bracket. The bottom row shows the average weighted by the bracket sample size."
)
```

\clearpage

```{r event-study, fig.cap = "Event-study Analysis (Wage Earners)"}
data_summary$event_study(include_pid = TRUE)
```

```{r overall-elasticity3}
data3_2 <- data3_1 %>%
  mutate(
    donate_ln_x0 = if_else(donate == 0, 0, log(donate)),
    donate_ln_x0.5 = if_else(donate == 0, -0.5, log(donate)),
    donate_ln_x3 = if_else(donate == 0, -3, log(donate)),
  )

mods <- list(
  donate_ln_x0 ~ applicable + ..stage2_e,
  donate_ln_x0 ~ ..stage2_e | effective ~ applicable,
  donate_ln_x0.5 ~ applicable + ..stage2_e,
  donate_ln_x0.5 ~ ..stage2_e | effective ~ applicable,
  donate_ln_x3 ~ applicable + ..stage2_e,
  donate_ln_x3 ~ ..stage2_e | effective ~ applicable
)

est_mods <- mods %>%
  map(~ feols(., data = data3_2, vcov = ~ hhid))

ivf <- sapply(est_mods, function(x) get_fitstat(x, "ivf", "stat")) %>%
  sapply(function(x) ifelse(is.na(x), "", sprintf("\\num{%1.3f}", x)))

whp <- sapply(est_mods, function(x) get_fitstat(x, "wh", "p")) %>%
  sapply(function(x) ifelse(is.na(x), "", sprintf("\\num{%1.3f}", x))) %>%
  sapply(function(x) ifelse(x == "\\num{0.000}", "$<$ \\num{0.001}", x))

stat <- data.frame(rbind(ivf, whp))
stat <- cbind(
  term = c("F-stats of instrument", "Wu-Hausman test, p-value"),
  stat
)

est_mods %>%
  modelsummary(
    title = "Robust Analysis of Overall First-Price Elasticities (Wage Earners Only)",
    coef_map = c(
      "applicable" = "Applicable price ($\\beta_a$)",
      "effective" = "Effective price ($\\beta^{FE}_e$)",
      "fit_effective" = "Effective price ($\\beta^{IV}_e$)",
      "after_tax_tinc_ln" = "Log after-tax income"
    ),
    gof_omit = "R2 Pseudo|R2 Within|AIC|BIC|Log|Std|FE|R2|RMSE",
    stars = c("***" = 0.01, "**" = 0.05, "*" = 0.1),
    add_rows = stat,
    escape = FALSE
  ) %>%
  kable_styling(font_size = 8) %>%
  add_header_above(
    c(
      "Extensive-margin value ($x$)" = 1,
      "$x = 0$" = 2,
      "$x = 0.5$" = 2,
      "$x = 3$" = 2
    ),
    escape = FALSE
  ) %>%
  group_rows(
    "1st stage information (Excluded instrument: Applicatble price)",
    8, 9,
    bold = FALSE, italic = TRUE
  ) %>%
  footnote(
    general_title = "",
    general = str_glue("
      Notes: * $p < 0.1$, ** $p < 0.05$, *** $p < 0.01$. Standard errors clustered at the household level are in parentheses. We only use wage earners. An outcome variable is the logged value of donation. We first normalize an amount of donation so that 1 corresponds to the value of the minimum nonzero donation in the data ($0.2$KRW). Then, we then transform an amount of donation to $m(g)$, where $m(y) = \\\\log(y)$ for $y > 0$ and $m(0) = -x$ for some choice of $x$. In addition to logged income, covariates consist of squared age (divided by 100), number of household members, number of children, number of dependents, a dummy that indicates the highest income in a household, a dummy that indicates that a taxpayer is household head, a dummy that indicates a wage earner, a set of industry dummies, a set of residential area dummies, and individual and time fixed effects. The excluded instrument is a logged applicable price.
    "),
    threeparttable = TRUE,
    escape = FALSE
  )
```

\clearpage
# Generalization of Relationship between Two Price Elasticities

Let $p_E = 1 - D q$ be an effective price, where $D$ is an indicator of reporting and $q$ is tax incentive. This price determines the amount of donation: $g(p_e)$. We omit income for simplicity. Let $p_A = 1 - q$ be an applicable price. Thus, the effective price is a function of the applicable price: $p_E(p_A)$. Then, the applicable price elasticity is
\begin{equation}
\begin{split}
  e^A
  &= \frac{\partial g(p_E)}{\partial p_A} \frac{p_A}{g(p_E)} \\
  &= \left(\frac{\partial g(p_E)}{\partial p_E}\frac{p_E}{g(p_E)} \right)
  \left(\frac{\partial p_E}{\partial p_A}\frac{p_A}{p_E} \right) \\
  &= e^E \times e^P,
\end{split}
\end{equation}
where $e^E$ is the effective price elasticity and $e^P$ implies that 1 percent increase in the applicable price leads to $e^P$ percent increase in the effective price. If we can estimate two parameters, then we can also recover the remaining parameter.