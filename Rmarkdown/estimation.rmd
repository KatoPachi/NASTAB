---
title: "Preview: Statistical Model"
author: Hiroki Kato
output:
  html_document:
    toc: true
    toc_float: true
params:
  preview: true
---

```{r include = FALSE, eval = params$preview}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo = FALSE,
  cache = FALSE,
  include = TRUE,
  fig.width = 10
)

library(here)
knitr::opts_knit$set(
  root.dir = here::here()
)

options(
  knitr.kable.NA = " ",
  knitr.table.format = "html",
  modelsummary_stars_note = FALSE
)
```

```{r include = FALSE, eval = params$preview}
library(xfun)
xfun::pkg_attach2(c(
  "tidyverse", "rlist", "modelsummary", "kableExtra",
  "estimatr", "fixest"
))

lapply(Sys.glob(file.path("script/R/functions", "*.r")), source)
```

```{r include = FALSE, eval = params$preview}
df <- readr::read_csv(
  "data/shaped2.csv",
  col_types = cols(
    ext_credit_giving = col_double(),
    krw_credit_giving = col_double(),
    trust_politician = col_double(),
    political_pref = col_double(),
    addtax = col_double(),
    avg_welfare_tax = col_double(),
    opt_welfare_tax = col_double(),
    now_balance = col_double(),
    ideal_balance = col_double()
  )
)
```

# Statistical Model

```{r SummaryOutcome2, fig.cap = ""}
df %>%
  mutate(group = case_when(
    credit_loss == 1 ~ 3,
    credit_neutral == 1 ~ 2,
    credit_benefit == 1 ~ 1
  )) %>%
  dplyr::filter(!is.na(group)) %>%
  group_by(year, group) %>%
  summarize(mu = mean(log_total_g, na.rm = TRUE)) %>%
  tidyr::pivot_wider(names_from = "year", values_from = "mu") %>%
  mutate(base = `2013`) %>%
  dplyr::select(group, base, everything()) %>%
  tidyr::pivot_longer(- (group:base), values_to = "mu", names_to = "year") %>%
  mutate(mu = mu / base, year = as.numeric(year)) %>%
  mutate(group = factor(
    group,
    labels = c("< 1200", "[1200, 4600]", "> 4600")
  )) %>%
  ggplot(aes(x = year, y = mu, group = group)) +
  geom_point(aes(color = group)) +
  geom_line(aes(color = group)) +
  geom_vline(aes(xintercept = 2013.5), linetype = 3) +
  scale_x_continuous(breaks = seq(2012, 2018, 1)) +
  labs(
    x = "Year",
    y = "The ratio of mean donations (logged value)",
    color = "Income group (unit:10,000KRW)",
    caption = paste(
      "The ratio is calculated by",
      "(mean of logged donation in year t) / (mean of logged donation in 2013)."
    )
  ) +
  ggtemp()
```

To estimate the giving price elasticity,
we use DID-like strategy which exploit the fact that the giving price was unified in 2014
while the price was different for tax payers with different incomes.
Figure \@ref(fig:SummaryOutcome2) the logarithmic average of donations for each year for each of the three income groups.
We created three income groups, with the relative price of giving rising (lower than 12,000,000 KRW),
unchanged (between 12,000,000 KRW and 46,000,000 KRW),
and falling (higher than 46,000,000 KRW) between 2013 and 2014.
In addition, the average logarithmic value of giving is standardized to be 1 in 2013. 

We can observe two facts from this figure.
First, before the tax reform, the amount of donations of income groups whose prices have increased or unchanged has remained the same,
but since the 2014 tax reform, the amount of giving of income groups whose price has risen was lower than the group whose price has unchanged.
Second, before the tax reform, the income group whose price decreased was lower than the group whose prices did not change,
but after the 2014 tax reform, the average donations of the two groups have been about the same.
In particular, since 2016,
the average donation amount of income groups whose price has decreased is slightly higher than that of groups whose price has not changed.
These facts in descriptive statistics suggest that
the exogenous shock of giving price by the 2014 tax reform has produced a  price effect for donations.

Using this exogenous change in price, we estimate the price elasticity of donations.
Then, we assume the following 2-way fixed effect model:
\begin{equation}
    \ln g_{it} = \varepsilon_p R_{it} \ln p_{it}(y_{it}, g_{it}) + \varepsilon_y \ln y_{it} 
    + X_{it}\beta +\mu_i +\iota_t +u_{it}, (\#eq:intensive)
\end{equation}
where $g_{it}, p_{it}$ and $y_{it}$ respectively indicates
the amount of giving, the giving price (if they apply for a tax deduction/credit), and income of $i$ in year $t$.
$R_{it}$ is a dummy taking one if individual $i$ applies for a tax deduction/credit in year $t$.
If s/he does not apply for a tax deduction/credit ($R_{it} = 0$), then the relative giving price is one ($p_{it} = 1$),
and its logarithmic value is zero.
$\mu_i, \iota_t$ and $u_{it}$ are individual fixed effect, year fixed effect, and the error term, respectively. 
$X_{it}$ is a vector of covariates including square of age, industry dummy, and area dummy.

## Endogenity of Giving Price $p_{it}$

Our identification strategy is price changes due to the 2014 tax reform.
However, the relative price of donations is endogenous
because it is necessary to use donation data under the income deduction system (before the 2014 tax reform).
To formally show this issue, the relative price of donations $p_{it}$ is defined as:
\begin{align}
  p_{it}(y_{it}, g_{it}) =
  \begin{cases}
    1 - \tau_t(y_{it} - g_{it})  \quad\text{if}\quad t < 2014  \\
    1 - m \quad\text{if}\quad t \ge 2014
  \end{cases}, (\#eq:price)
\end{align}
where $\tau_t(\cdot)$ is average tax rate in year $t$.
As is clear from the above formula,
the (within) variation in giving price depends not only on the 2014 tax reform
but also on the amount of donations and income before 2014,
which are factors in the endogenous nature of the giving price.

In the tax deduction system,
the giving price is endogenous
because taxpayers can reduce the amount of donations and
lower their tax brackets by one level to lower the relative price of giving.
To address this endogeneity, consider the price faced in the first unit of donation denoted by $p^f_{it}$.
This is called the first-price of giving and is obtained by $p^f_{it}(y_{it}) = p_{it}(y_{it}, 0)$.
In contrast, $p_{it}(y_{it}, g_{it})$ is called the last-price of giving[^fprice_credit].
The first-price of giving is unaffected by the manipulation of giving,
so the first-price is exogenous to the donation amount.
Therefore, assuming that the income is exogenous,
we replace $\ln p_{it}(y_{it}, g_{it})$ in the Equation \@ref(eq:intensive) with $\ln p^f_{it}(y_{it})$
to estimate the first-price elasticity of giving.
Also, using the first-price of giving as the instrumental variable for that last-price,
we estimate the Equation \@ref(eq:intensive) with 2SLS with fixed effects.

[^fprice_credit]: Under the tax credit system, the relative price of donations does not depend on the donation amount. Thus, the first-price of giving is equal to the last-price of giving.

Since income is generally endogenous,
the first-price of giving is also an endogenous variable. 
Under the income deduction system,
changes in income affect donations through the income effect 
and the giving price through marginal tax rates [@Randolph1995; @Auten2002; @Bakija2011].
Therefore, following @Almunia2020 and @Bakija2011,
we use the lagged variable of income
to construct the following variable that captures the change in the first-price of donations:
\begin{align}
  \Delta^k \ln p^f_{it}(y_{it-k}) = \ln \left(\frac{p^f_{it}(y_{it-k})}{p^f_{it-k}(y_{it-k})}\right),
  (\#eq:laggedp)
\end{align}
where the numerator is the first price that individual $i$ would have faced in year $t$
if she had declared her year $(t - k)$ taxable income at that year. 
By fixing the income at year $t - k$,
this variable isolates changes in price from income manipulation[^fprice_lag].

[^fprice_lag]: If the tax credit system is adopted in years $t$ and $t-k$, the value of this variable, $\Delta^k \ln p_{it}(y_{it-k})$ will be zero because the giving price under the tax credit system is independent of income.

Using this variable as an instrument, we estimate the following $k$-th difference model:
\begin{align}
  \Delta^k \ln g_{it} = \varepsilon_p \Delta^k \ln p_{it}(y_{it}, y_{it-k}) + \varepsilon_y \Delta^k \ln y_{it} 
  + \Delta^k X_{it} \beta + \mu_i + \iota_t + v_{it}, (\#eq:kdiff)
\end{align}
where $\Delta^k \ln g_{it} = \ln (g_{it} / g_{it-k})$,
and $\Delta^k \ln y_{it} = \ln (y_{it} / y_{it-k})$.
The variable $\Delta^k p^f_{it}(y_{it}, y_{it-k}) = \ln (p^f_{it}(y_{it}) / p^f_{it-k}(y_{it-k}))$ is
instumented by $\Delta^k \ln p^f_{it}(y_{it-k})$.

## Endogenity of Applying for Tax Deduction/Credit $R_{it}$