# Estimation

## Empirical strategies
Following @Almunia2020, we estimate giving price elasticity for intensive margin and extensive margin. The elasticity of intensive margin shows how much donors additionally donates reacting to the marginal increase of giving price, while the elasticity of extensive margin shows how much the probability to donate changes reacting to marginal increase of giving price. 

We estimate the elasticity of intensive margin using the following specification:
$$
\ln g_{it} = \varepsilon_{INT} \ln p_{it} +g_{INT} \ln y_{it} + X_{it}\beta +\mu_i +\iota_t +u_{it}. \label{intensive}
$$
$g_{it}, p_{it}$ and $y_{it}$ respectively indicates the amount of giving, the giving price, and income of $i$ in year $t$.  $\mu_i, \iota_t$ and $u_{it}$ are individual fixed effect, year fixed effect and error term, respectively. 
The individual fixed effect controls for time-invariant individual characteristics. The year fixed effect controls for events that affect all subjects at the same time. $X_{it}$ is a vector of covariates which include variables about education and gender. Moreover, we add some interaction terms between year fixed effect and control variables into $X_{it}$, since they will control for events that affects subject with specific characteristics at the same time following @Zeldow2019.

The elasticity of extensive margin is estimated using the linear probability model such as
$$
D_{it} =  \delta \ln p_{it} +\gamma \ln y_{it} + X_{it}\beta+\mu_i  +\iota_t +v_it. \label{extensive}
$$
$D_{it}$ is a dummy variable taking 1 if individual $i$ donates at year $t$ and 0 otherwise. We use linear probability model following @Almunia2020 since the fitted probabilities always take values within the range of (0, 1). Using $e_{EXT}$ in this equation, the price elasticity of extensive margin can be calculated as $\varepsilon_{EXT} = \gamma/\bar{D}$. $\bar{D}$ is the sample mean of $D_{it}$, which is the proportion of donors in our sample in year t.

Our identification strategy to estimate the price elasticity exploits the exogenous giving price change made by tax reform in 2014. The tax reform brought the reduction of giving price for individual whose income was low, while the high income earner faced the increment of giving price and the price was not changed for the middle income individual. Figure XXX shows the residual plot which shows the average residuals of E.q. (\ref{intensive}) for three different groups: (i) income $<$ 12 million KRW, (ii) income $\in$ [12 million KRW, 46 million KRW), and (iii) income $>$ 46 million KRW. We can consider that group (i) and (iii) respectively experienced the giving price reduction and increase, while the giving price for group (ii) remained the same, in the 2014 tax reform. Contrary to the expectation, the amount of donations increase for group (iii) while it reduce for group (i) after the tax reform in Figure XXX. However, figure XXX plotting the average residuals of each group of E.q. (\ref{extensive}) observes the reduction of donation for group (iii) as expected. Thus, the tax reform in 2014 might have a large effect on the extensive margin of donation. 

ここらへんの議論ですが、以下の点、要検討です。これらが解決しないと残差プロットの図を出す意味は殆どないと思います。
 
 - 残差プロットの図がIntensive marginについて、期待される図とはかなり異なる結果を出しているので、どう議論しようか悩みどころです。
 - 平行トレンドについてですが、ここでは政策変更前の期間が1期しかないので、チェックできません。なので、個人的には政府の効率性の議論にかかわらず、期間を延長して分析・図を見せるのもありだと思います。とりあえずのバージョンでは平行トレンドについては書きません。

### Obstacles for identification
The estimations based on Eq. (\ref{Intensive}) and (\ref{Extensive}) are likely to show biased estimates because there are two potential endogeneity problem: (A) endogeneity of giving price and (B) simultaneous determination of income and donations. For the issue (A), the tax payer can reduce their giving price by increasing their amount of donation and shifting themselves to the lower tax bracket in the tax deduction system. Since this issue does not happen for the first one unit of donation, whose price ("first price") cannot be changed by adjusting the donation, we use this first price as the giving price in the estimation. The first price is formally defined as the giving price $p^d_i\equiv 1−\tau (y_i−g_i)$, evaluated at $g_i=0$. Moreover, this issue does not happen in the tax credit system because the giving price in the tax credit system is exogenously determined by the rate of tax credit allowance. Therefore, we construct the giving price in the tax credit system based on the rate of tax credit allowance.

Regarding issue (B), the change of income caused by the tax reform have effects on both donations through the income effect and the giving price through the marginal tax rate. Therefore, we employ lagged values of taxable income and construct an instrument variable for the change in the first price of giving as following:

$$
ln (\frac{p_{it}(y_{it-k} - g_{it-k})}{p_{it-k}(y_{it-k} - g_{it-k})}).
$$
The numerator is the first price that individual i would have faced in year t if she had declared her year (t − k) taxable income at that year. By using the income level which is not affected by the tax reform, the instrument isolates changes in price from income responses to the tax reform. Note that this problem does not happen for the tax credit system, where the giving price is the same across all individuals.


# Main Results

<!--- Slide
## Price and Income Elasticity
--->

```{stata Elasticity, results = "hide", eval = FALSE}
xtreg log_total_g log_price log_pinc_all i.year, fe vce(cluster pid)

mat coeftab = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab = Logprice_M0 Loginc_M0

mat stattab = e(N) \ e(r2)
mat colnames stattab = M0
mat rownames stattab = N r2

predict resid, e

* with covariates
local cov sqage i.year##i.educ i.year##i.gender i.year##i.living_area
local xvars 
local k = 1
foreach v of local cov {
	di "model `k'"
    
	*make set of covariates
	local xvars `xvars' `v'
	
	*estimate fixed effect model
	xtreg log_total_g log_price log_pinc_all i.year age `xvars', fe vce(cluster pid)
	
	*matrix of regression result
	mat coef = r(table)["b".."pvalue","log_price".."log_pinc_all"]
	mat colnames coef = Logprice_M`k' Loginc_M`k'
	
	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	*combined with previous results
	mat_capp coeftab : coeftab coef
	mat_capp stattab : stattab stat

	local k = `++k'
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/ElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/ElasticityStat.dta, replace) rownames(xvar) names(col)

* residuals plot
frame copy default plotdt
frame plotdt {
	by year benefit_group, sort: egen meang = mean(resid)
	
	keep meang year benefit_group
	duplicates drop
	keep if !missing(benefit_group)
	
	gen meang_norm = meang if year == 2013
	by benefit_group, sort: egen meang13 = mean(meang_norm) 
	gen meang_n = meang - meang13
}

frame plotdt {
	twoway ///
	(connected meang_n year if benefit_group == 1, sort msymbol(O) color(black))  ///
	(connected meang_n year if benefit_group == 2, sort msymbol(T) color(black))  ///
	(connected meang_n year if benefit_group == 3, sort msymbol(S) color(black)),  ///
	xline(2013.5, lcolor(red) lpattern(-)) ///
	xlabel(2012(1)2018) xtitle("Year")  ///
	ytitle("Average Residuals (Normalized)")  ///
	legend(label(1 "Income {&lt} 1200") label(2 " Income in [1200, 4600)") label(3 "Income {&ge} 4600"))  ///
	graphregion(fcolor(white))

	graph export "_assets/ElasticityResid.pdf", replace
}

frame drop plotdt
```

```{stata ExtElasticity, results = "hide", eval = FALSE}
* baseline
xtreg i_ext_giving log_price log_pinc_all i.year, fe vce(cluster pid)

mat coeftab = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab = Logprice_M0 Loginc_M0

mat stattab = e(N) \ e(r2)
mat colnames stattab = M0
mat rownames stattab = N r

predict residext, e

* price elasticity evaluated at mean
summarize i_ext_giving
local mu = r(mean)
lincom log_price*(1/`mu')

mat elas1 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas1 = Logprice_M0
mat rownames elas1 = e_b e_se e_pval

* price elasticity evaluated at mean
summarize i_ext_giving
local mu = r(mean)
lincom log_pinc_all*(1/`mu')

mat elas2 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas2 = Loginc_M0
mat rownames elas2 = e_b e_se e_pval

* baseline result
mat_capp elas : elas1 elas2
mat_rapp coeftab : coeftab elas


* with covariates
local cov sqage i.year##i.educ i.year##i.gender i.year##i.living_area
local xvars 
local k = 1
foreach v of local cov {
	di "model `k'"
    
	*make set of covariates
	local xvars `xvars' `v'
	
	*estimate fixed effect model
	xtreg i_ext_giving log_price log_pinc_all i.year age `xvars', fe vce(cluster pid)
	
	*matrix of regression result
	mat coef = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
	mat colnames coef = Logprice_M`k' Loginc_M`k'

	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r
	
	*proportion of donors
	summarize i_ext_giving
	local mu = r(mean)
	
	* price elasticity evaluated at mean
	summarize i_ext_giving
	local mu = r(mean)
	lincom log_price*(1/`mu')

	mat elas1 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
	mat colnames elas1 = Logprice_M`k'
	mat rownames elas1 = e_b e_se e_pval

	* price elasticity evaluated at mean
	summarize i_ext_giving
	local mu = r(mean)
	lincom log_pinc_all*(1/`mu')

	mat elas2 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
	mat colnames elas2 = Loginc_M`k'
	mat rownames elas2 = e_b e_se e_pval
	
	*combined with previous results
	mat_capp elas : elas1 elas2
	mat_rapp coef : coef elas
	mat_capp coeftab : coeftab coef
	
	mat_capp stattab : stattab stat

	local k = `++k'
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/ExtElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/ExtElasticityStat.dta, replace) rownames(xvar) names(col)

* residuals plot
frame copy default plotdt
frame plotdt {
	by year benefit_group, sort: egen meang = mean(residext)
	
	keep meang year benefit_group
	duplicates drop
	keep if !missing(benefit_group)
	
	gen meang_norm = meang if year == 2013
	by benefit_group, sort: egen meang13 = mean(meang_norm) 
	gen meang_n = meang - meang13
}

frame plotdt {
	twoway ///
	(connected meang_n year if benefit_group == 1, sort msymbol(O) color(black))  ///
	(connected meang_n year if benefit_group == 2, sort msymbol(T) color(black))  ///
	(connected meang_n year if benefit_group == 3, sort msymbol(S) color(black)),  ///
	xline(2013.5, lcolor(red) lpattern(-)) ///
	xlabel(2012(1)2018) xtitle("Year")  ///
	ytitle("Average Residuals (Normalized)")  ///
	legend(label(1 "Income {&lt} 1200") label(2 " Income in [1200, 4600)") label(3 "Income {&ge} 4600"))  ///
	graphregion(fcolor(white))

	graph export "_assets/ExtElasticityResid.pdf", replace
}

frame drop plotdt
```

```{stata IntElasticity, results = "hide", eval = FALSE}
* baseline
xtreg log_total_g log_price log_pinc_all i.year if i_ext_giving == 1, fe vce(cluster pid)

mat coeftab = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab = Logprice_M0 Loginc_M0

mat stattab = e(N) \ e(r2)
mat colnames stattab = M0
mat rownames stattab = N r2

predict residint, e

* with covariates
local cov sqage i.year##i.educ i.year##i.gender i.year##i.living_area
local xvars 
local k = 1
foreach v of local cov {
	di "model `k'"
    
	*make set of covariates
	local xvars `xvars' `v'
	
	*estimate fixed effect model
	xtreg log_total_g log_price log_pinc_all i.year age `xvars' if i_ext_giving == 1, fe vce(cluster pid)
	
	*matrix of regression result
	mat coef = r(table)["b".."pvalue","log_price".."log_pinc_all"]
	mat colnames coef = Logprice_M`k' Loginc_M`k'
	
	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	*combined with previous results
	mat_capp coeftab : coeftab coef
	mat_capp stattab : stattab stat

	local k = `++k'
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/IntElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/IntElasticityStat.dta, replace) rownames(xvar) names(col)

* residuals plot
frame copy default plotdt
frame plotdt {
	by year benefit_group, sort: egen meang = mean(residint)
	
	keep meang year benefit_group
	duplicates drop
	keep if !missing(benefit_group)
	
	gen meang_norm = meang if year == 2013
	by benefit_group, sort: egen meang13 = mean(meang_norm) 
	gen meang_n = meang - meang13
}

frame plotdt {
	twoway ///
	(connected meang_n year if benefit_group == 1, sort msymbol(O) color(black))  ///
	(connected meang_n year if benefit_group == 2, sort msymbol(T) color(black))  ///
	(connected meang_n year if benefit_group == 3, sort msymbol(S) color(black)),  ///
	xline(2013.5, lcolor(red) lpattern(-)) ///
	xlabel(2012(1)2018) xtitle("Year")  ///
	ytitle("Average Residuals (Normalized)")  ///
	legend(label(1 "Income {&lt} 1200") label(2 " Income in [1200, 4600)") label(3 "Income {&ge} 4600"))  ///
	graphregion(fcolor(white))

	graph export "_assets/IntElasticityResid.pdf", replace
}

frame drop plotdt
```

```{r, include = TRUE, out.width="90%", fig.cap="Average Residuals Grouped by Year and Tax-Reform Benefit Group"}
knitr::include_graphics(paste(here(), "_assets/ElasticityResid.pdf", sep= "/"))
```


```{r shapeElasticity}
coeftab <- list(
	overall = read.dta13("_assets/ElasticityCoef.dta") %>% data.frame(),
	intensive = read.dta13("_assets/IntElasticityCoef.dta") %>% data.frame(),
	extensive = read.dta13("_assets/ExtElasticityCoef.dta") %>% data.frame()
)

shape_coeftab <- coeftab %>% 
	purrr::map(function(x)
		x %>% 
			filter(!str_detect(xvar, "e_")) %>%
			pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
			pivot_wider(values_from = "value", names_from = "xvar") %>% 
			mutate(
				b = case_when(
					pvalue <= 0.01 ~ sprintf("%1.3f***", b),
					pvalue <= 0.05 ~ sprintf("%1.3f**", b),
					pvalue <= 0.1 ~ sprintf("%1.3f*", b),
					TRUE ~ sprintf("%1.3f", b)
				),
				se = sprintf("(%1.3f)", se)
			) %>% 
			select(-t, -pvalue) %>% 
			pivot_longer(cols = b:se, values_to = "value", names_to = "stat") %>% 
			pivot_wider(values_from = "value", names_from = "model") %>%
			mutate(
				vars = case_when(
					stat == "se" ~ "",
					vars == "Logprice" ~ "ln(giving price)",
					vars == "Loginc" ~ "ln(auunaul taxable income)"
				)
			) %>% 
			select(-stat)
	)

elastab <- coeftab$extensive %>% 
	filter(str_detect(xvar, "e_")) %>%
	pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
	pivot_wider(values_from = "value", names_from = "xvar") %>% 
	mutate(
		e_b = case_when(
			e_pval <= 0.01 ~ sprintf("%1.3f***", e_b),
			e_pval <= 0.05 ~ sprintf("%1.3f**", e_b),
			e_pval <= 0.1 ~ sprintf("%1.3f*", e_b),
			TRUE ~ sprintf("%1.3f", e_b)
		),
		e_se = sprintf("(%1.3f)", e_se)
	) %>% 
	select(-e_pval) %>% 
	pivot_longer(cols = e_b:e_se, values_to = "value", names_to = "stat") %>% 
	pivot_wider(values_from = "value", names_from = "model") %>%
	mutate(
		vars = case_when(
			stat == "e_se" ~ "",
			vars == "Logprice" ~ "Implied price elasiticity",
			vars == "Loginc" ~ "Implied income elasticity"
		)
	) %>% 
	select(-stat)

shape_coeftab$extensive <- rbind(shape_coeftab$extensive, elastab)

stattab <- list(
	overall = read.dta13("_assets/ElasticityStat.dta") %>% data.frame(),
	intensive = read.dta13("_assets/IntElasticityStat.dta") %>% data.frame(),
	extensive = read.dta13("_assets/ExtElasticityStat.dta") %>% data.frame()
) %>% 
purrr::map(function(x) 
	x %>% mutate_at(
		vars(-xvar),
		list(~case_when(xvar == "N" ~ sprintf("%1.0f", .), TRUE ~ sprintf("%1.3f", .)))
	) %>% 
	mutate(xvar = recode(xvar, "r" = "R-sq", "r2" = "R-sq", .default = xvar)) %>% 
	rename(vars = xvar)
)

addline <- cbind(
	vars = c("Individual FE", "Time FE", "Age", "Year X Education", "Year X Gender", "Year X Resident Area"),
	M0 = c(rep("Y", 2), rep("N", 4)),
	M1 = c(rep("Y", 3), rep("N", 3)),
	M2 = c(rep("Y", 4), rep("N", 2)),
	M3 = c(rep("Y", 5), rep("N", 1)),
	M4 = rep("Y", 6)
)

tabular <- c("overall", "intensive", "extensive") %>% 
	purrr::map(function(x) rbind(shape_coeftab[[x]], addline) %>% rbind(stattab[[x]]))

alltab <- tabular[[1]]
intexttab <- rbind(tabular[[2]][-(5:10),], tabular[[3]])
```

<!--- Slide
## Baseline Regressions: Result
We found the **price effect** of giving (1\% price increase leads to about 1.1\% giving decrease)
-->

```{r kableEstimateElasticityPart1, include = TRUE}
knitr::kable(
    alltab,
    format = "latex",
    caption = "Main Results",
    col.names = c("", "(1)", "(2)", "(3)", "(4)", "(5)"),
    row.names = FALSE,
    align = "lccccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 8) %>% 
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. When controlling age, we alson include its squared term.", threeparttable = TRUE, escape = FALSE)
```


<!--- Slide
## Intensive Margin and Extensive Margin: Result
--->

```{r, include = TRUE, out.width="90%", fig.cap="Average Residuals Grouped by Year and Tax-Reform Benefit Group (Intensive Margin)"}
knitr::include_graphics(paste(here(), "_assets/IntElasticityResid.pdf", sep= "/"))
```

```{r, include = TRUE, out.width="90%", fig.cap="Average Residuals Grouped by Year and Tax-Reform Benefit Group (Extensive Margin)"}
knitr::include_graphics(paste(here(), "_assets/ExtElasticityResid.pdf", sep= "/"))
```

```{r kableEstimateElasticityPart2, include = TRUE}
knitr::kable(
    intexttab,
    format = "latex",
    caption = "Main Results: Intensive- and Extensive-Margin Elasticity",
    col.names = c("", "(1)", "(2)", "(3)", "(4)", "(5)"),
    row.names = FALSE,
    align = "lccccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 8) %>% 
pack_rows("Intensive-Margin Elasticity", 1, 6) %>% 
pack_rows("Extensive-Margin Elasticity", 7, 22) %>% 
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. When controlling age, we alson include its squared term. The implied extensive-marign price elasticity is evaluated at the sample mean of $D_{ijt}$.", threeparttable = TRUE, escape = FALSE)
```

<!--- Slide
## Robustness Check

1. Income and donations are determined simultaneously
1. Effect of presidential transition on donation behavior
1. Last price elasticity
1. Self-selection of receiving tax benefit
1. Transitory and permanent elasticity
--->

<!--- Slide
## Robustness Check 1

First potential concern: Income and donations are determined simultaneously
    
- This causes both a change of giving price and a change of an amount of donations
- Gruber and Saez (2002) provided that we should use $\log(\text{Price}_{ijt}/\text{Price}_{ij(t-k)})$ as an insturment.
- We estimated the model (5) in the previous slide, using the panel IV model for $k = 1, 2, 3$.
	- Note that Alumnia (2020) took a strategy of $k$-difference model.
--->

```{stata LastElasticity, results = "hide", eval = FALSE}
* first stage
xtreg log_lprice log_price log_pinc_all i.year, fe vce(cluster pid)

mat fstage = r(table)["b".."pvalue","log_price"]
mat fstage = fstage[1,1] \ fstage[3,1]^2
mat colnames fstage = M0
mat rownames fstage = ivcoef ivf

* second stage
xtivreg log_total_g log_pinc_all i.year (log_lprice = log_price), fe vce(cluster pid)

mat coeftab = r(table)["b".."pvalue", "log_lprice".."log_pinc_all"]
mat colnames coeftab = Loglprice_M0 Loginc_M0

mat stattab = e(N) \ e(r2)
mat colnames stattab = M0
mat rownames stattab = N r2

mat_rapp stattab : stattab fstage

* with covariates
local cov sqage i.year##i.educ i.year##i.gender i.year##i.living_area
local xvars 
local k = 1
foreach v of local cov {
	di "model `k'"
    
	*make set of covariates
	local xvars `xvars' `v'
	
	*first stage
	xtreg log_lprice log_price log_pinc_all i.year age `xvars', fe vce(cluster pid)
	
	mat fstage = r(table)["b".."pvalue","log_price"]
	mat fstage = fstage[1,1] \ fstage[3,1]^2
	mat colnames fstage = M`k'
	mat rownames fstage = ivcoef ivf
	
	*second stage
	xtivreg log_total_g log_pinc_all i.year age `xvars' (log_lprice = log_price), fe vce(cluster pid)
	
	mat coef = r(table)["b".."pvalue", "log_lprice".."log_pinc_all"]
	mat colnames coef = Loglprice_M`k' Loginc_M`k'

	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	mat_rapp stat : stat fstage
	
	*combined with previous results
	mat_capp coeftab : coeftab coef
	mat_capp stattab : stattab stat

	local k = `++k'
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/LastElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/LastElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{stata LastExtElasticity, results = "hide", eval = FALSE}
* first stage
xtreg log_lprice log_price log_pinc_all i.year, fe vce(cluster pid)

mat fstage = r(table)["b".."pvalue","log_price"]
mat fstage = fstage[1,1] \ fstage[3,1]^2
mat colnames fstage = M0
mat rownames fstage = ivcoef ivf

* second stage
xtivreg i_ext_giving log_pinc_all i.year (log_lprice = log_price), fe vce(cluster pid)

mat coeftab = r(table)["b".."pvalue", "log_lprice".."log_pinc_all"]
mat colnames coeftab = Loglprice_M0 Loginc_M0

mat stattab = e(N) \ e(r2)
mat colnames stattab = M0
mat rownames stattab = N r2

* price elasticity evaluated at mean
summarize i_ext_giving
local mu = r(mean)
lincom log_lprice*(1/`mu')

mat elas1 = r(estimate) \ r(se) \ (1 - normal(abs(r(estimate)/r(se))))*2
mat colnames elas1 = Loglprice_M0
mat rownames elas1 = e_b e_se e_pval

* price elasticity evaluated at mean
summarize i_ext_giving
local mu = r(mean)
lincom log_pinc_all*(1/`mu')

mat elas2 = r(estimate) \ r(se) \ (1 - normal(abs(r(estimate)/r(se))))*2
mat colnames elas2 = Loginc_M0
mat rownames elas2 = e_b e_se e_pval

mat_capp elas : elas1 elas2
mat_rapp coeftab : coeftab elas
mat_rapp stattab : stattab fstage

* with covariates
local cov sqage i.year##i.educ i.year##i.gender i.year##i.living_area
local xvars 
local k = 1
foreach v of local cov {
	di "model `k'"
    
	*make set of covariates
	local xvars `xvars' `v'
	
	*first stage
	xtreg log_lprice log_price log_pinc_all i.year age `xvars', fe vce(cluster pid)
	
	mat fstage = r(table)["b".."pvalue","log_price"]
	mat fstage = fstage[1,1] \ fstage[3,1]^2
	mat colnames fstage = M`k'
	mat rownames fstage = ivcoef ivf
	
	*second stage
	xtivreg i_ext_giving log_pinc_all i.year age `xvars' (log_lprice = log_price), fe vce(cluster pid)
	
	mat coef = r(table)["b".."pvalue", "log_lprice".."log_pinc_all"]
	mat colnames coef = Loglprice_M`k' Loginc_M`k'

	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	* price elasticity evaluated at mean
	summarize i_ext_giving
	local mu = r(mean)
	lincom log_lprice*(1/`mu')

	mat elas1 = r(estimate) \ r(se) \ (1 - normal(abs(r(estimate)/r(se))))*2
	mat colnames elas1 = Loglprice_M`k'
	mat rownames elas1 = e_b e_se e_pval

	* price elasticity evaluated at mean
	summarize i_ext_giving
	local mu = r(mean)
	lincom log_pinc_all*(1/`mu')

	mat elas2 = r(estimate) \ r(se) \ (1 - normal(abs(r(estimate)/r(se))))*2
	mat colnames elas2 = Loginc_M`k'
	mat rownames elas2 = e_b e_se e_pval

	mat_capp elas : elas1 elas2
	mat_rapp coef : coef elas
	mat_rapp stat : stat fstage
	
	*combined with previous results
	mat_capp coeftab : coeftab coef
	mat_capp stattab : stattab stat

	local k = `++k'
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/LastExtElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/LastExtElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{stata LastIntElasticity, results = "hide", eval = FALSE}
* first stage
xtreg log_lprice log_price log_pinc_all i.year if i_ext_giving == 1, fe vce(cluster pid)

mat fstage = r(table)["b".."pvalue","log_price"]
mat fstage = fstage[1,1] \ fstage[3,1]^2
mat colnames fstage = M0
mat rownames fstage = ivcoef ivf

* second stage
xtivreg log_total_g log_pinc_all i.year (log_lprice = log_price) if i_ext_giving == 1, fe vce(cluster pid)

mat coeftab = r(table)["b".."pvalue", "log_lprice".."log_pinc_all"]
mat colnames coeftab = Loglprice_M0 Loginc_M0

mat stattab = e(N) \ e(r2)
mat colnames stattab = M0
mat rownames stattab = N r2

mat_rapp stattab : stattab fstage

* with covariates
local cov sqage i.year##i.educ i.year##i.gender i.year##i.living_area
local xvars 
local k = 1
foreach v of local cov {
	di "model `k'"
    
	*make set of covariates
	local xvars `xvars' `v'
	
	*first stage
	xtreg log_lprice log_price log_pinc_all i.year age `xvars' if i_ext_giving == 1, fe vce(cluster pid)
	
	mat fstage = r(table)["b".."pvalue","log_price"]
	mat fstage = fstage[1,1] \ fstage[3,1]^2
	mat colnames fstage = M`k'
	mat rownames fstage = ivcoef ivf
	
	*second stage
	xtivreg log_total_g log_pinc_all i.year age `xvars' (log_lprice = log_price) if i_ext_giving == 1, fe vce(cluster pid)
	
	mat coef = r(table)["b".."pvalue", "log_lprice".."log_pinc_all"]
	mat colnames coef = Loglprice_M`k' Loginc_M`k'

	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	mat_rapp stat : stat fstage
	
	*combined with previous results
	mat_capp coeftab : coeftab coef
	mat_capp stattab : stattab stat

	local k = `++k'
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/LastIntElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/LastIntElasticityStat.dta, replace) rownames(xvar) names(col)
```

<!--- Slide
## Robustness Check 1: Result
---> 

```{r shapeLastElasticity}
coeftab <- list(
	overall = read.dta13("_assets/LastElasticityCoef.dta") %>% data.frame(),
	intensive = read.dta13("_assets/LastIntElasticityCoef.dta") %>% data.frame(),
	extensive = read.dta13("_assets/LastExtElasticityCoef.dta") %>% data.frame()
)

shape_coeftab <- coeftab %>% 
	purrr::map(function(x)
		x %>% 
			filter(!str_detect(xvar, "e_")) %>%
			pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
			pivot_wider(values_from = "value", names_from = "xvar") %>% 
			mutate(
				b = case_when(
					pvalue <= 0.01 ~ sprintf("%1.3f***", b),
					pvalue <= 0.05 ~ sprintf("%1.3f**", b),
					pvalue <= 0.1 ~ sprintf("%1.3f*", b),
					TRUE ~ sprintf("%1.3f", b)
				),
				se = sprintf("(%1.3f)", se)
			) %>% 
			select(-z, -pvalue) %>% 
			pivot_longer(cols = b:se, values_to = "value", names_to = "stat") %>% 
			pivot_wider(values_from = "value", names_from = "model") %>%
			mutate(
				vars = case_when(
					stat == "se" ~ "",
					vars == "Loglprice" ~ "ln(last giving price)",
					vars == "Loginc" ~ "ln(auunaul taxable income)"
				)
			) %>% 
			select(-stat)
	)

elastab <- coeftab$extensive %>% 
	filter(str_detect(xvar, "e_")) %>%
	pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
	pivot_wider(values_from = "value", names_from = "xvar") %>% 
	mutate(
		e_b = case_when(
			e_pval <= 0.01 ~ sprintf("%1.3f***", e_b),
			e_pval <= 0.05 ~ sprintf("%1.3f**", e_b),
			e_pval <= 0.1 ~ sprintf("%1.3f*", e_b),
			TRUE ~ sprintf("%1.3f", e_b)
		),
		e_se = sprintf("(%1.3f)", e_se)
	) %>% 
	select(-e_pval) %>% 
	pivot_longer(cols = e_b:e_se, values_to = "value", names_to = "stat") %>% 
	pivot_wider(values_from = "value", names_from = "model") %>%
	mutate(
		vars = case_when(
			stat == "e_se" ~ "",
			vars == "Loglprice" ~ "Implied last price elasiticity",
			vars == "Loginc" ~ "Implied income elasticity"
		)
	) %>% 
	select(-stat)

shape_coeftab$extensive <- rbind(shape_coeftab$extensive, elastab)

stattab <- list(
	overall = read.dta13("_assets/LastElasticityStat.dta") %>% data.frame(),
	intensive = read.dta13("_assets/LastIntElasticityStat.dta") %>% data.frame(),
	extensive = read.dta13("_assets/LastExtElasticityStat.dta") %>% data.frame()
) %>% 
purrr::map(function(x) 
	x %>% mutate_at(
		vars(-xvar),
		list(~case_when(xvar == "N" ~ sprintf("%1.0f", .), TRUE ~ sprintf("%1.2f", .)))
	) %>% 
	mutate(xvar = recode(xvar, "r2" = "R-sq", "ivf" = "F-statistics of IV", .default = xvar)) %>% 
	rename(vars = xvar) %>% 
	filter(vars != "R-sq" & vars != "ivcoef") %>% 
	.[c(2,1),]
)

addline <- cbind(
	vars = c("Individual FE", "Time FE", "Age", "Year X Education", "Year X Gender", "Year X Resident Area"),
	M0 = c(rep("Y", 2), rep("N", 4)),
	M1 = c(rep("Y", 3), rep("N", 3)),
	M2 = c(rep("Y", 4), rep("N", 2)),
	M3 = c(rep("Y", 5), rep("N", 1)),
	M4 = rep("Y", 6)
)

tabular <- c("overall", "intensive", "extensive") %>% 
	purrr::map(function(x) rbind(shape_coeftab[[x]], addline) %>% rbind(stattab[[x]]))

alltab <- tabular[[1]]
intexttab <- rbind(tabular[[2]][-(5:10),], tabular[[3]])
```

```{r kableLastElasticity1, include = TRUE}
knitr::kable(
    alltab,
    format = "latex",
    caption = "Last Price Elasticity: Panel IV",
    col.names = c("", "(1)", "(2)", "(3)", "(4)", "(5)"),
    row.names = FALSE,
    align = "lccccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 8) %>% 
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. The instumental variable is the first giving price in year $t$. When controlling age, we alson include its squared term.", threeparttable = TRUE, escape = FALSE)
```

<!--- Slide
## Robustness Check 1: Intensive and Extensive Margin
--->

```{r kableLastElasticity2, include = TRUE}
knitr::kable(
    intexttab,
    format = "latex",
    caption = "Intensive- and Extensive-Margin Last Price Elasticity: Panel IV",
    col.names = c("", "(1)", "(2)", "(3)", "(4)", "(5)"),
    row.names = FALSE,
    align = "lccccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 8) %>% 
pack_rows("Intensive-Margin Elasticity", 1, 6) %>% 
pack_rows("Extensive-Margin Elasticity", 7, 22) %>% 
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. The instumental variable is the first giving price in year $t$. When controlling age, we alson include its squared term. The implied extensive-marign price elasticity is evaluated at the sample mean of $D_{ijt}$.", threeparttable = TRUE, escape = FALSE)
```

<!--- Slide
## Robust Check 2

Second potential concern: The effect of presidential transition on donations 
    
- The presidential transition is one of our major ommited factor to charitable giving.
	- In May 2017, South Korea president changed from Park Geun-hye to Moon Jae-in. This presidential transition was due to the impeachment charge against Park Geun-hye. People became distrustful of her due to the shinking of MV Sewol (April 2014).
- To shed light on this concern, we used data in 2013 and 2014 (President was Park Geun-hye in both years), and estimated the model (5) in the previous slide, using the fixed effect model and the panel IV model for $k = 1, 2, 3$.
--->


```{stata ShortElasticity, results = "hide", eval = FALSE}
* M0: year >= 2013 without cov
xtreg log_total_g log_price log_pinc_all i.year if year >= 2013, fe vce(cluster pid)

mat coeftab0 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab0 = Logprice_M0 Loginc_M0

mat stattab0 = e(N) \ e(r2)
mat colnames stattab0 = M0
mat rownames stattab0 = N r2

* M1: year >= 2013 with cov
xtreg log_total_g log_price log_pinc_all i.year age sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
	if year >= 2013, fe vce(cluster pid)

mat coeftab1 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab1 = Logprice_M1 Loginc_M1

mat stattab1 = e(N) \ e(r2)
mat colnames stattab1 = M1
mat rownames stattab1 = N r2

* M2: year == 2013 | 2014 without cov
xtreg log_total_g log_price log_pinc_all i.year if year == 2013 | year == 2014, fe vce(cluster pid)

mat coeftab2 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab2 = Logprice_M2 Loginc_M2

mat stattab2 = e(N) \ e(r2)
mat colnames stattab2 = M2
mat rownames stattab2 = N r2

* M3: year == 2013 | 2014 with cov
xtreg log_total_g log_price log_pinc_all i.year age sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
	if year == 2013 | year == 2014, fe vce(cluster pid)

mat coeftab3 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab3 = Logprice_M3 Loginc_M3

mat stattab3 = e(N) \ e(r2)
mat colnames stattab3 = M3
mat rownames stattab3 = N r2

mat_capp coeftab : coeftab0 coeftab1
mat_capp coeftab : coeftab coeftab2
mat_capp coeftab : coeftab coeftab3

mat_capp stattab : stattab0 stattab1
mat_capp stattab : stattab stattab2
mat_capp stattab : stattab stattab3

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/ShortElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/ShortElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{stata ShortIntElasticity, results = "hide", eval = FALSE}
* M0: year >= 2013 without cov
xtreg log_total_g log_price log_pinc_all i.year if year >= 2013 & i_ext_giving == 1, fe vce(cluster pid)

mat coeftab0 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab0 = Logprice_M0 Loginc_M0

mat stattab0 = e(N) \ e(r2)
mat colnames stattab0 = M0
mat rownames stattab0 = N r2

* M1: year >= 2013 with cov
xtreg log_total_g log_price log_pinc_all i.year age sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
	if year >= 2013 & i_ext_giving == 1, fe vce(cluster pid)

mat coeftab1 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab1 = Logprice_M1 Loginc_M1

mat stattab1 = e(N) \ e(r2)
mat colnames stattab1 = M1
mat rownames stattab1 = N r2

* M2: year == 2013 | 2014 without cov
xtreg log_total_g log_price log_pinc_all i.year if (year == 2013 | year == 2014) & i_ext_giving == 1, fe vce(cluster pid)

mat coeftab2 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab2 = Logprice_M2 Loginc_M2

mat stattab2 = e(N) \ e(r2)
mat colnames stattab2 = M2
mat rownames stattab2 = N r2

* M3: year == 2013 | 2014 with cov
xtreg log_total_g log_price log_pinc_all i.year age sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
	if (year == 2013 | year == 2014) & i_ext_giving == 1, fe vce(cluster pid)

mat coeftab3 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab3 = Logprice_M3 Loginc_M3

mat stattab3 = e(N) \ e(r2)
mat colnames stattab3 = M3
mat rownames stattab3 = N r2

mat_capp coeftab : coeftab0 coeftab1
mat_capp coeftab : coeftab coeftab2
mat_capp coeftab : coeftab coeftab3

mat_capp stattab : stattab0 stattab1
mat_capp stattab : stattab stattab2
mat_capp stattab : stattab stattab3

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/ShortIntElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/ShortIntElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{stata ShortExtElasticity, results = "hide", eval = FALSE}
** M0: year >= 2013 without cov
xtreg i_ext_giving log_price log_pinc_all i.year if year >= 2013, fe vce(cluster pid)

mat coeftab0 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab0 = Logprice_M0 Loginc_M0

mat stattab0 = e(N) \ e(r2)
mat colnames stattab0 = M0
mat rownames stattab0 = N r2

* price elasticity evaluated at mean
summarize i_ext_giving if year >= 2013
local mu = r(mean)
lincom log_price*(1/`mu')

mat elas1 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas1 = Logprice_M0
mat rownames elas1 = e_b e_se e_pval

* price elasticity evaluated at mean
summarize i_ext_giving if year >= 2013
local mu = r(mean)
lincom log_pinc_all*(1/`mu')

mat elas2 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas2 = Loginc_M0
mat rownames elas2 = e_b e_se e_pval

mat_capp elas : elas1 elas2
mat_rapp coeftab0 : coeftab0 elas

** M1: year >= 2013 with cov
xtreg i_ext_giving log_price log_pinc_all i.year age sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
	if year >= 2013, fe vce(cluster pid)

mat coeftab1 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab1 = Logprice_M1 Loginc_M1

mat stattab1 = e(N) \ e(r2)
mat colnames stattab1 = M1
mat rownames stattab1 = N r2

* price elasticity evaluated at mean
summarize i_ext_giving if year >= 2013
local mu = r(mean)
lincom log_price*(1/`mu')

mat elas1 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas1 = Logprice_M1
mat rownames elas1 = e_b e_se e_pval

* price elasticity evaluated at mean
summarize i_ext_giving if year >= 2013
local mu = r(mean)
lincom log_pinc_all*(1/`mu')

mat elas2 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas2 = Loginc_M1
mat rownames elas2 = e_b e_se e_pval

mat_capp elas : elas1 elas2
mat_rapp coeftab1 : coeftab1 elas

** M2: year == 2013 | 2014 without cov
xtreg i_ext_giving log_price log_pinc_all i.year if year == 2013 | year == 2014, fe vce(cluster pid)

mat coeftab2 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab2 = Logprice_M2 Loginc_M2

mat stattab2 = e(N) \ e(r2)
mat colnames stattab2 = M2
mat rownames stattab2 = N r2

* price elasticity evaluated at mean
summarize i_ext_giving if year == 2013 | year == 2014
local mu = r(mean)
lincom log_price*(1/`mu')

mat elas1 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas1 = Logprice_M2
mat rownames elas1 = e_b e_se e_pval

* price elasticity evaluated at mean
summarize i_ext_giving if year == 2013 | year == 2014
local mu = r(mean)
lincom log_pinc_all*(1/`mu')

mat elas2 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas2 = Loginc_M2
mat rownames elas2 = e_b e_se e_pval

mat_capp elas : elas1 elas2
mat_rapp coeftab2 : coeftab2 elas

** M3: year == 2013 | 2014 with cov
xtreg i_ext_giving log_price log_pinc_all i.year age sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
	if year == 2013 | year == 2014, fe vce(cluster pid)

mat coeftab3 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab3 = Logprice_M3 Loginc_M3

mat stattab3 = e(N) \ e(r2)
mat colnames stattab3 = M3
mat rownames stattab3 = N r2

* price elasticity evaluated at mean
summarize i_ext_giving if year == 2013 | year == 2014
local mu = r(mean)
lincom log_price*(1/`mu')

mat elas1 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas1 = Logprice_M3
mat rownames elas1 = e_b e_se e_pval

* price elasticity evaluated at mean
summarize i_ext_giving if year == 2013 | year == 2014
local mu = r(mean)
lincom log_pinc_all*(1/`mu')

mat elas2 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas2 = Loginc_M3
mat rownames elas2 = e_b e_se e_pval

mat_capp elas : elas1 elas2
mat_rapp coeftab3 : coeftab3 elas

mat_capp coeftab : coeftab0 coeftab1
mat_capp coeftab : coeftab coeftab2
mat_capp coeftab : coeftab coeftab3

mat_capp stattab : stattab0 stattab1
mat_capp stattab : stattab stattab2
mat_capp stattab : stattab stattab3

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/ShortExtElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/ShortExtElasticityStat.dta, replace) rownames(xvar) names(col)
```

<!--- Slide
## Robustness Check 2: Result
--->

```{r shapeShortElasticity}
coeftab <- list(
	overall = read.dta13("_assets/ShortElasticityCoef.dta") %>% data.frame(),
	intensive = read.dta13("_assets/ShortIntElasticityCoef.dta") %>% data.frame(),
	extensive = read.dta13("_assets/ShortExtElasticityCoef.dta") %>% data.frame()
)

shape_coeftab <- coeftab %>% 
	purrr::map(function(x)
		x %>% 
			filter(!str_detect(xvar, "e_")) %>%
			pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
			pivot_wider(values_from = "value", names_from = "xvar") %>% 
			mutate(
				b = case_when(
					pvalue <= 0.01 ~ sprintf("%1.3f***", b),
					pvalue <= 0.05 ~ sprintf("%1.3f**", b),
					pvalue <= 0.1 ~ sprintf("%1.3f*", b),
					TRUE ~ sprintf("%1.3f", b)
				),
				se = sprintf("(%1.3f)", se)
			) %>% 
			select(-t, -pvalue) %>% 
			pivot_longer(cols = b:se, values_to = "value", names_to = "stat") %>% 
			pivot_wider(values_from = "value", names_from = "model") %>%
			mutate(
				vars = case_when(
					stat == "se" ~ "",
					vars == "Logprice" ~ "ln(giving price)",
					vars == "Loginc" ~ "ln(auunaul taxable income)"
				)
			) %>% 
			select(-stat)
	)

elastab <- coeftab$extensive %>% 
	filter(str_detect(xvar, "e_")) %>%
	pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
	pivot_wider(values_from = "value", names_from = "xvar") %>% 
	mutate(
		e_b = case_when(
			e_pval <= 0.01 ~ sprintf("%1.3f***", e_b),
			e_pval <= 0.05 ~ sprintf("%1.3f**", e_b),
			e_pval <= 0.1 ~ sprintf("%1.3f*", e_b),
			TRUE ~ sprintf("%1.3f", e_b)
		),
		e_se = sprintf("(%1.3f)", e_se)
	) %>% 
	select(-e_pval) %>% 
	pivot_longer(cols = e_b:e_se, values_to = "value", names_to = "stat") %>% 
	pivot_wider(values_from = "value", names_from = "model") %>%
	mutate(
		vars = case_when(
			stat == "e_se" ~ "",
			vars == "Logprice" ~ "Implied price elasiticity",
			vars == "Loginc" ~ "Implied income elasticity"
		)
	) %>% 
	select(-stat)

shape_coeftab$extensive <- rbind(shape_coeftab$extensive, elastab)

stattab <- list(
	overall = read.dta13("_assets/ShortElasticityStat.dta") %>% data.frame(),
	intensive = read.dta13("_assets/ShortIntElasticityStat.dta") %>% data.frame(),
	extensive = read.dta13("_assets/ShortExtElasticityStat.dta") %>% data.frame()
) %>% 
purrr::map(function(x) 
	x %>% mutate_at(
		vars(-xvar),
		list(~case_when(xvar == "N" ~ sprintf("%1.0f", .), TRUE ~ sprintf("%1.3f", .)))
	) %>% 
	mutate(xvar = recode(xvar, "r" = "R-sq", "r2" = "R-sq", .default = xvar)) %>% 
	rename(vars = xvar)
)

addline <- cbind(
	vars = c("Individual FE", "Time FE", "Other Controls"),
	M0 = c(rep("Y", 2), "N"),
	M1 = rep("Y", 3),
	M2 = c(rep("Y", 2), "N"),
	M3 = rep("Y", 3)
)

tabular <- c("overall", "intensive", "extensive") %>% 
	purrr::map(function(x) rbind(shape_coeftab[[x]], addline) %>% rbind(stattab[[x]]))

alltab <- tabular[[1]]
intexttab <- rbind(tabular[[2]][-(5:7),], tabular[[3]])
```

```{r kableShortElasticity1, include=TRUE}
knitr::kable(
    alltab,
    format = "latex",
    caption = "Elasticity with Short-Period Data",
    col.names = c("", "(1)", "(2)", "(3)", "(4)"),
    row.names = FALSE,
    align = "lcccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 8) %>% 
add_header_above(c(" " = 1, "After 2012" = 2, "2013 and 2014" = 2), escape = FALSE) %>%
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. Other controls are age (its squared value), the interaction between year dummies and education dummies, the interaction between year dummies and gender dummies, and the interaction between year dummies and resident area.", threeparttable = TRUE, escape = FALSE)
```

<!--- Slide
## Robustness Check 2: Intensive and Extensive Margin
--->

```{r kableShortElasticity2, include=TRUE}
knitr::kable(
    intexttab,
    format = "latex",
    caption = "Intensive- and Extensive-Margin Elasticity with Short-Period Data",
    col.names = c("", "(1)", "(2)", "(3)", "(4)"),
    row.names = FALSE,
    align = "lcccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 8) %>% 
pack_rows("Intensive-Margin Elasticity", 1, 6) %>% 
pack_rows("Extensive-Margin Elasticity", 7, 19) %>% 
add_header_above(c(" " = 1, "After 2012" = 2, "2013 and 2014" = 2), escape = FALSE) %>%
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. Other controls are age (its squared value), the interaction between year dummies and education dummies, the interaction between year dummies and gender dummies, and the interaction between year dummies and resident area. The implied extensive-marign price elasticity is evaluated at the sample mean of $D_{ijt}$.", threeparttable = TRUE, escape = FALSE)
```

```{stata kDiffElasticity, results = "hide", eval = FALSE}
forvalues k = 1(1)3 {
    
	di "lag = `k'"
	
	* panel regression
	xtreg log_diff`k'g log_iv`k'price log_diff`k'I diff`k'_age diff`k'_sqage i.year##i.educ i.year##i.gender i.year##i.living_area, ///
		fe vce(cluster pid)
	
	* result of panel regression
	mat coef = r(table)["b".."pvalue","log_iv`k'price".."log_diff`k'I"]
	mat colnames coef = Logdiffprice_M`k' Logdiffinc_M`k'
	
	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	if `k' == 1 {
	    mat coeftab = coef
		mat stattab = stat
	}
	else {
	    mat_capp coeftab : coeftab coef
		mat_capp stattab : stattab stat
	}
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/kDiffElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/kDiffElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{stata kDiffIntElasticity, results = "hide", eval = FALSE}
forvalues k = 1(1)3 {
    
	di "lag = `k'"
	
	* panel regression
	xtreg log_diff`k'g log_iv`k'price log_diff`k'I diff`k'_age diff`k'_sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
		if i_ext_giving == 1, fe vce(cluster pid)
	
	* result of panel regression
	mat coef = r(table)["b".."pvalue","log_iv`k'price".."log_diff`k'I"]
	mat colnames coef = Logdiffprice_M`k' Logdiffinc_M`k'
	
	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	if `k' == 1 {
	    mat coeftab = coef
		mat stattab = stat
	}
	else {
	    mat_capp coeftab : coeftab coef
		mat_capp stattab : stattab stat
	}
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/kDiffIntElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/kDiffIntElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{r shapekDiffElasticity}
coeftab <- list(
	overall = read.dta13("_assets/kDiffElasticityCoef.dta") %>% data.frame(),
	intensive = read.dta13("_assets/kDiffIntElasticityCoef.dta") %>% data.frame()
)

shape_coeftab <- coeftab %>% 
	purrr::map(function(x)
		x %>% 
			filter(!str_detect(xvar, "e_")) %>%
			pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
			pivot_wider(values_from = "value", names_from = "xvar") %>% 
			mutate(
				b = case_when(
					pvalue <= 0.01 ~ sprintf("%1.3f***", b),
					pvalue <= 0.05 ~ sprintf("%1.3f**", b),
					pvalue <= 0.1 ~ sprintf("%1.3f*", b),
					TRUE ~ sprintf("%1.3f", b)
				),
				se = sprintf("(%1.3f)", se)
			) %>% 
			select(-t, -pvalue) %>% 
			pivot_longer(cols = b:se, values_to = "value", names_to = "stat") %>% 
			pivot_wider(values_from = "value", names_from = "model") %>%
			mutate(
				vars = case_when(
					stat == "se" ~ "",
					vars == "Logdiffprice" ~ "Lagged difference of first price (log)",
					vars == "Logdiffinc" ~ "Lagged difference of annual income (log)"
				)
			) %>% 
			select(-stat)
	)

stattab <- list(
	overall = read.dta13("_assets/kDiffElasticityStat.dta") %>% data.frame(),
	intensive = read.dta13("_assets/kDiffIntElasticityStat.dta") %>% data.frame()
) %>% 
purrr::map(function(x) 
	x %>% mutate_at(
		vars(-xvar),
		list(~case_when(xvar == "N" ~ sprintf("%1.0f", .), TRUE ~ sprintf("%1.3f", .)))
	) %>% 
	mutate(xvar = recode(xvar, "r" = "R-sq", "r2" = "R-sq", .default = xvar)) %>% 
	rename(vars = xvar)
)

addline <- cbind(
	vars = c("Individual FE", "Time FE", "Other Controls"),
	M1 = rep("Y", 3),
	M2 = rep("Y", 3),
	M3 = rep("Y", 3)
)

tabular <- c("overall", "intensive") %>% 
	purrr::map(function(x) rbind(shape_coeftab[[x]], addline) %>% rbind(stattab[[x]]))

alltab <- rbind(tabular[[1]][-(5:7),], tabular[[2]])
```

```{r kablekDiffElasticity, include=TRUE}
knitr::kable(
    alltab,
    format = "latex",
    caption = "Estimation of Elasticity: $k$-difference model",
    col.names = c("", "(1)", "(2)", "(3)"),
    row.names = FALSE,
    align = "lccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 8) %>% 
pack_rows("Overall Elasticity", 1, 6) %>% 
pack_rows("Intensive-Margin Elasticity", 7, 15) %>% 
add_header_above(c("lag $k$" = 1, "$k = 1$" = 1, "$k = 2$" = 1, "$k = 3$" = 1), escape = FALSE) %>%
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. The lagged difference of first price (log) is $\\\\ln(\\\\text{Price}^k_{ijt}) - \\\\ln(\\\\text{Price}_{ij(t-k)})$, where $\\\\text{Price}^k_{ijt}$ calculates the giving price under the tax system in year $t$, using annual taxable income in year $t-k$, $\\\\text{Income}_{ij(t-k)}$. The lagged of annual income (log) is $\\\\ln(\\\\text{Income}_{ijt}) - \\\\ln(\\\\text{Income}_{ij(t-k)})$. Other controls are lagged difference of age, lagged difference of squared age, the interaction between year dummies and education dummies, the interaction between year dummies and gender dummies, and the interaction between year dummies and resident area.", threeparttable = TRUE, escape = FALSE)
```