# Main Results

```{stata Elasticity, results = "hide", eval = FALSE}
xtreg log_total_g log_price log_pinc_all i.year, fe vce(cluster pid)

mat coeftab = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab = Logprice_M0 Loginc_M0

mat stattab = e(N) \ e(r2)
mat colnames stattab = M0
mat rownames stattab = N r2

predict resid, e

* with covariates
local cov sqage i.year##i.educ i.year##i.gender i.year##i.living_area
local xvars 
local k = 1
foreach v of local cov {
	di "model `k'"
    
	*make set of covariates
	local xvars `xvars' `v'
	
	*estimate fixed effect model
	xtreg log_total_g log_price log_pinc_all i.year age `xvars', fe vce(cluster pid)
	
	*matrix of regression result
	mat coef = r(table)["b".."pvalue","log_price".."log_pinc_all"]
	mat colnames coef = Logprice_M`k' Loginc_M`k'
	
	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	*combined with previous results
	mat_capp coeftab : coeftab coef
	mat_capp stattab : stattab stat

	local k = `++k'
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/ElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/ElasticityStat.dta, replace) rownames(xvar) names(col)

* residuals plot
frame copy default plotdt
frame plotdt {
	by year benefit_group, sort: egen meang = mean(resid)
	
	keep meang year benefit_group
	duplicates drop
	keep if !missing(benefit_group)
	
	gen meang_norm = meang if year == 2013
	by benefit_group, sort: egen meang13 = mean(meang_norm) 
	gen meang_n = meang - meang13
}

frame plotdt {
	twoway ///
	(connected meang_n year if benefit_group == 1, sort msymbol(O) color(black))  ///
	(connected meang_n year if benefit_group == 2, sort msymbol(T) color(black))  ///
	(connected meang_n year if benefit_group == 3, sort msymbol(S) color(black)),  ///
	xline(2013.5, lcolor(red) lpattern(-)) ///
	xlabel(2012(1)2018) xtitle("Year")  ///
	ytitle("Average Residuals (Normalized)")  ///
	legend(label(1 "Income {&lt} 1200") label(2 " Income in [1200, 4600)") label(3 "Income {&ge} 4600"))  ///
	graphregion(fcolor(white))

	graph export "_assets/ElasticityResid.pdf", replace
}

frame drop plotdt
```

```{stata ExtElasticity, results = "hide", eval = FALSE}
* baseline
xtreg i_ext_giving log_price log_pinc_all i.year, fe vce(cluster pid)

mat coeftab = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab = Logprice_M0 Loginc_M0

mat stattab = e(N) \ e(r2)
mat colnames stattab = M0
mat rownames stattab = N r

predict residext, e

* price elasticity evaluated at mean
summarize i_ext_giving
local mu = r(mean)
lincom log_price*(1/`mu')

mat elas1 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas1 = Logprice_M0
mat rownames elas1 = e_b e_se e_pval

* price elasticity evaluated at mean
summarize i_ext_giving
local mu = r(mean)
lincom log_pinc_all*(1/`mu')

mat elas2 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas2 = Loginc_M0
mat rownames elas2 = e_b e_se e_pval

* baseline result
mat_capp elas : elas1 elas2
mat_rapp coeftab : coeftab elas


* with covariates
local cov sqage i.year##i.educ i.year##i.gender i.year##i.living_area
local xvars 
local k = 1
foreach v of local cov {
	di "model `k'"
    
	*make set of covariates
	local xvars `xvars' `v'
	
	*estimate fixed effect model
	xtreg i_ext_giving log_price log_pinc_all i.year age `xvars', fe vce(cluster pid)
	
	*matrix of regression result
	mat coef = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
	mat colnames coef = Logprice_M`k' Loginc_M`k'

	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r
	
	*proportion of donors
	summarize i_ext_giving
	local mu = r(mean)
	
	* price elasticity evaluated at mean
	summarize i_ext_giving
	local mu = r(mean)
	lincom log_price*(1/`mu')

	mat elas1 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
	mat colnames elas1 = Logprice_M`k'
	mat rownames elas1 = e_b e_se e_pval

	* price elasticity evaluated at mean
	summarize i_ext_giving
	local mu = r(mean)
	lincom log_pinc_all*(1/`mu')

	mat elas2 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
	mat colnames elas2 = Loginc_M`k'
	mat rownames elas2 = e_b e_se e_pval
	
	*combined with previous results
	mat_capp elas : elas1 elas2
	mat_rapp coef : coef elas
	mat_capp coeftab : coeftab coef
	
	mat_capp stattab : stattab stat

	local k = `++k'
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/ExtElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/ExtElasticityStat.dta, replace) rownames(xvar) names(col)

* residuals plot
frame copy default plotdt
frame plotdt {
	by year benefit_group, sort: egen meang = mean(residext)
	
	keep meang year benefit_group
	duplicates drop
	keep if !missing(benefit_group)
	
	gen meang_norm = meang if year == 2013
	by benefit_group, sort: egen meang13 = mean(meang_norm) 
	gen meang_n = meang - meang13
}

frame plotdt {
	twoway ///
	(connected meang_n year if benefit_group == 1, sort msymbol(O) color(black))  ///
	(connected meang_n year if benefit_group == 2, sort msymbol(T) color(black))  ///
	(connected meang_n year if benefit_group == 3, sort msymbol(S) color(black)),  ///
	xline(2013.5, lcolor(red) lpattern(-)) ///
	xlabel(2012(1)2018) xtitle("Year")  ///
	ytitle("Average Residuals (Normalized)")  ///
	legend(label(1 "Income {&lt} 1200") label(2 " Income in [1200, 4600)") label(3 "Income {&ge} 4600"))  ///
	graphregion(fcolor(white))

	graph export "_assets/ExtElasticityResid.pdf", replace
}

frame drop plotdt
```

```{stata IntElasticity, results = "hide", eval = FALSE}
* baseline
xtreg log_total_g log_price log_pinc_all i.year if i_ext_giving == 1, fe vce(cluster pid)

mat coeftab = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab = Logprice_M0 Loginc_M0

mat stattab = e(N) \ e(r2)
mat colnames stattab = M0
mat rownames stattab = N r2

predict residint, e

* with covariates
local cov sqage i.year##i.educ i.year##i.gender i.year##i.living_area
local xvars 
local k = 1
foreach v of local cov {
	di "model `k'"
    
	*make set of covariates
	local xvars `xvars' `v'
	
	*estimate fixed effect model
	xtreg log_total_g log_price log_pinc_all i.year age `xvars' if i_ext_giving == 1, fe vce(cluster pid)
	
	*matrix of regression result
	mat coef = r(table)["b".."pvalue","log_price".."log_pinc_all"]
	mat colnames coef = Logprice_M`k' Loginc_M`k'
	
	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	*combined with previous results
	mat_capp coeftab : coeftab coef
	mat_capp stattab : stattab stat

	local k = `++k'
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/IntElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/IntElasticityStat.dta, replace) rownames(xvar) names(col)

* residuals plot
frame copy default plotdt
frame plotdt {
	by year benefit_group, sort: egen meang = mean(residint)
	
	keep meang year benefit_group
	duplicates drop
	keep if !missing(benefit_group)
	
	gen meang_norm = meang if year == 2013
	by benefit_group, sort: egen meang13 = mean(meang_norm) 
	gen meang_n = meang - meang13
}

frame plotdt {
	twoway ///
	(connected meang_n year if benefit_group == 1, sort msymbol(O) color(black))  ///
	(connected meang_n year if benefit_group == 2, sort msymbol(T) color(black))  ///
	(connected meang_n year if benefit_group == 3, sort msymbol(S) color(black)),  ///
	xline(2013.5, lcolor(red) lpattern(-)) ///
	xlabel(2012(1)2018) xtitle("Year")  ///
	ytitle("Average Residuals (Normalized)")  ///
	legend(label(1 "Income {&lt} 1200") label(2 " Income in [1200, 4600)") label(3 "Income {&ge} 4600"))  ///
	graphregion(fcolor(white))

	graph export "_assets/IntElasticityResid.pdf", replace
}

frame drop plotdt
```

<!--- Slides
## Price and Income Elasticity

- To show our baseline results graphically, Figure \@ref(fig:showElasticityResid) shows average residuals grouped by year and benefit of the 2014 tax reform.
    - Residuals are obtained from the regression of logged donations on logged annual taxable income, individual and time fixed year.

## Price and Income Elasticity: Residuals Plot

Those who incurring loss owing to the 2014 tax reform drastically decreases thier amount of donations.

```{r showElasticityResid, include = TRUE, out.width="80%", fig.cap="Average Residuals Grouped by Year and Tax-Reform Benefit Group", eval = FALSE}
knitr::include_graphics(paste(here(), "_assets/ElasticityResid.pdf", sep= "/"))
```
--->

## Price and Income Elasticity

<!-- Slide
We found the **price effect** of giving (1\% price increase leads to about 1.1\% giving decrease),
and the **income effect** of giving(1\% income increase leads to about 5\% giving increase).
--->

Before the estimation of giving price elasticities for intensive and extensive margin, we estimate the elasticity without distinguishing them. We call this elasticity as overall elasticity.
Table \@ref(tab:kableEstimateElasticityPart1) shows estimation results of overall elasticity.
The column (1) is the baseline estimation, which include individual and time fixed effects.
The price elasticity is rougly -1, which is statistically significant different from zero.
This implies that 1\% increase of giving price raise charitable giving by 1\%.
This result is in line with previous researches which focus on Western countries.
The income elasticity is about 5.3, which is statistically significant different from zero.
This implies that 1\% increase of annual income raise charitable giving by 5.3\%.
The remaining four columns control for events that affects subject with specific characteristics at the same time.
As a result, the price elasticity is more elastic than the baseline result.
The price elasticity lies between -1.3 and -1.1.
On the other hand, the income elasticity is less elastic than the baseline result.
The income elasticity lies between -5.1 and -4.9.


```{r shapeElasticity}
coeftab <- list(
	overall = read.dta13("_assets/ElasticityCoef.dta") %>% data.frame(),
	intensive = read.dta13("_assets/IntElasticityCoef.dta") %>% data.frame(),
	extensive = read.dta13("_assets/ExtElasticityCoef.dta") %>% data.frame()
)

shape_coeftab <- coeftab %>% 
	purrr::map(function(x)
		x %>% 
			filter(!str_detect(xvar, "e_")) %>%
			pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
			pivot_wider(values_from = "value", names_from = "xvar") %>% 
			mutate(
				b = case_when(
					pvalue <= 0.01 ~ sprintf("%1.3f***", b),
					pvalue <= 0.05 ~ sprintf("%1.3f**", b),
					pvalue <= 0.1 ~ sprintf("%1.3f*", b),
					TRUE ~ sprintf("%1.3f", b)
				),
				se = sprintf("(%1.3f)", se)
			) %>% 
			select(-t, -pvalue) %>% 
			pivot_longer(cols = b:se, values_to = "value", names_to = "stat") %>% 
			pivot_wider(values_from = "value", names_from = "model") %>%
			mutate(
				vars = case_when(
					stat == "se" ~ "",
					vars == "Logprice" ~ "ln(giving price)",
					vars == "Loginc" ~ "ln(auunaul taxable income)"
				)
			) %>% 
			select(-stat)
	)

elastab <- coeftab$extensive %>% 
	filter(str_detect(xvar, "e_")) %>%
	pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
	pivot_wider(values_from = "value", names_from = "xvar") %>% 
	mutate(
		e_b = case_when(
			e_pval <= 0.01 ~ sprintf("%1.3f***", e_b),
			e_pval <= 0.05 ~ sprintf("%1.3f**", e_b),
			e_pval <= 0.1 ~ sprintf("%1.3f*", e_b),
			TRUE ~ sprintf("%1.3f", e_b)
		),
		e_se = sprintf("(%1.3f)", e_se)
	) %>% 
	select(-e_pval) %>% 
	pivot_longer(cols = e_b:e_se, values_to = "value", names_to = "stat") %>% 
	pivot_wider(values_from = "value", names_from = "model") %>%
	mutate(
		vars = case_when(
			stat == "e_se" ~ "",
			vars == "Logprice" ~ "Implied price elasiticity",
			vars == "Loginc" ~ "Implied income elasticity"
		)
	) %>% 
	select(-stat)

shape_coeftab$extensive <- rbind(shape_coeftab$extensive, elastab)

stattab <- list(
	overall = read.dta13("_assets/ElasticityStat.dta") %>% data.frame(),
	intensive = read.dta13("_assets/IntElasticityStat.dta") %>% data.frame(),
	extensive = read.dta13("_assets/ExtElasticityStat.dta") %>% data.frame()
) %>% 
purrr::map(function(x) 
	x %>% mutate_at(
		vars(-xvar),
		list(~case_when(xvar == "N" ~ sprintf("%1.0f", .), TRUE ~ sprintf("%1.3f", .)))
	) %>% 
	mutate(xvar = recode(xvar, "r" = "R-sq", "r2" = "R-sq", .default = xvar)) %>% 
	rename(vars = xvar)
)

addline <- cbind(
	vars = c("Individual FE", "Time FE", "Age", "Year X Education", "Year X Gender", "Year X Resident Area"),
	M0 = c(rep("Y", 2), rep("N", 4)),
	M1 = c(rep("Y", 3), rep("N", 3)),
	M2 = c(rep("Y", 4), rep("N", 2)),
	M3 = c(rep("Y", 5), rep("N", 1)),
	M4 = rep("Y", 6)
)

tabular <- c("overall", "intensive", "extensive") %>% 
	purrr::map(function(x) rbind(shape_coeftab[[x]], addline) %>% rbind(stattab[[x]]))

alltab <- tabular[[1]]
intexttab <- rbind(tabular[[2]][-(5:10),], tabular[[3]])
```

```{r kableEstimateElasticityPart1, include = TRUE}
knitr::kable(
    alltab,
	#alltab[-c(5:6, 12),], slides
    format = "latex",
    caption = "Main Results",
    col.names = c("", "(1)", "(2)", "(3)", "(4)", "(5)"),
    row.names = FALSE,
    align = "lccccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 7) %>% 
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. When controlling age, we alson include its squared term.", threeparttable = TRUE, escape = FALSE)
```

<!-- Slide
## Intensive and Extensive Margin

- To obtain intensive- and extensive-margin elasticity, we repeat the same excercise.
- Figure \@ref(fig:showIntElasticityResid) shows average residuals grouped by year and benefit of the 2014 tax reform 
    - We used those who donated and estimated residuals obtained from the regression logged donations on logged annual taxable income, individual and time fixed year.
- Figure \@ref(fig:showExtElasticityResid) shows average residuals grouped by year and benefir of the 2014 tax reform.
    - We estimated residuals obtained from the regression the donation dummy on logged annual taxable income, individual and time fixed year.

## Intensive Margin: Residuals Plot

Donors who receive benefit owing to the 2014 tax reform decrease their donations in 2014 and 2015.

```{r showIntElasticityResid, include = TRUE, out.width="80%", fig.cap="Average Residuals Grouped by Year and Tax-Reform Benefit Group (Intensive Margin)", eval = FALSE}
knitr::include_graphics(paste(here(), "_assets/IntElasticityResid.pdf", sep= "/"))
```

## Extensive Margin: Residuals Plot

Those who incurring loss owing to the 2014 tax reform drastically were less likely to donate.

```{r showExtElasticityResid, include = TRUE, out.width="80%", fig.cap="Average Residuals Grouped by Year and Tax-Reform Benefit Group (Extensive Margin)", eval = FALSE}
knitr::include_graphics(paste(here(), "_assets/ExtElasticityResid.pdf", sep= "/"))
```

## Intensive and Extensive Margin: Estimation Results

The intensive-margin price elasticity is -0.5 ~ -1\%. 

```{r kableEstimateElasticityPart2Slide1, include = TRUE, eval = FALSE}
knitr::kable(
    rbind(intexttab[1:4,], intexttab[17:20,]) %>% rbind(intexttab[5,]),
    format = "latex",
    caption = "Main Results: Intensive-Margin Elasticity",
    col.names = c("", "(1)", "(2)", "(3)", "(4)", "(5)"),
    row.names = FALSE,
    align = "lccccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 7)
```

## Intensive and Extensive Margin: Estimation Results

The extensive-margin price elasticity is -1.2 ~ -1.4\%. 

```{r kableEstimateElasticityPart2Slide2, include = TRUE, eval = FALSE}
knitr::kable(
    rbind(intexttab[11:14,], intexttab[17:21,]),
    format = "latex",
    caption = "Main Results: Extensive-Margin Elasticity",
    col.names = c("", "(1)", "(2)", "(3)", "(4)", "(5)"),
    row.names = FALSE,
    align = "lccccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 7)
```
--->

Table \@ref(tab:kableEstimateElasticityPart2) shows the intensive-margin and the extensive-margin elasticities.
The first panel shows the intensive-margin elasticity.
Compared to the overall elasticitiy, the price and income elasticitiy are less elastic.
Controlling individual and time fixed effects, 
the price and income elasticity is about -0.6 and about 2,
which are statistically significant different from zero (See the column (1)).
Moreover, when we include the interaction term between individual characteristics and year dummies,
these values vary.
The price elasticity lies between -1.1 and -0.8,
and the income elasticity lies between 1.4 and 1.6.
Anyway, our conlusion is that the amount of donations is insensitive to the giving price among donors.

The second panel shows the extensive-margin elasticity.
By results of overall elasticities and the intensive-margin elasticities,
we expect that the extensive-margin price and income elasticity is more elastic than the overall elasticities.
In the column (1), the coefficient of logged giving price and logged annual income are -0.257 and 1.175 respectively,
which are statistically significant different from zero.
Since we use the linear probability model,
we need to calculate $\epsilon^p_{EXT} = -0.257/D_{it}$ and $\epsilon^y_{EXT} = 1.175/D_{it}$
to obtain the price and income elasticity, respectively. 
Especially, the coefficient of logged giving price represents the lower-bound of price elasticity
because the variable $D_{it}$ takes either 0 or 1.
When we evaluate the price elasticity at the sample mean of $D_{it}$,
the implied price elasticity is -1.264, which is slightly more elastic than the overall one.
Also, we evaluate the income elasticity at the sample mean of outcome.
The implied income elasticity is 5.778, which is slightly more elastic than the overall one.
Although the implied price and income elasticity varies with covariates,
results are in line with our expectation.
Thus, the decision of donations is sensitive to the giving price and annual income.

```{r kableEstimateElasticityPart2, include = TRUE}
knitr::kable(
    intexttab,
    format = "latex",
    caption = "Main Results: Intensive- and Extensive-Margin Elasticity",
    col.names = c("", "(1)", "(2)", "(3)", "(4)", "(5)"),
    row.names = FALSE,
    align = "lccccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 7) %>% 
pack_rows("Intensive-Margin Elasticity", 1, 6) %>% 
pack_rows("Extensive-Margin Elasticity", 7, 22) %>% 
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. When controlling age, we alson include its squared term. The implied extensive-marign price elasticity is evaluated at the sample mean of $D_{ijt}$.", threeparttable = TRUE, escape = FALSE)
```

In summary, our first conclusion is that 
the decision of donations is sensitive to the giving price, 
and the amount of donations is insensitive to the giving price once they decide to donate.
In the next subsection, we check the robustness of our first conclusion, using three methods.

## Robustness Check

<!-- Slide
First potential concern: last price elasticity

- Our baseline results show the **first** price elasticity to avoid the endogeneity of giving price.
- We estimated the **last** price elasticity, using the Panel IV method.
    - The instrument is the first giving price.
    - Note that the last giving price is equal to the first giving price under the tax credit system.
-->

The first robustness check is the last price elasticity.
Our main results show that *first* price elasticity to avoid the endogeneity of giving price.
However, the first prive elasiticity is not realistic
because people face the *last* marginal price when deciding amount of donations.
Thus, we estimate the *last* price elasticity, using the Panel IV method.
The instrumental variable is the first giving price.

\color{blue} 
There is one caution to interpret the last price elasticity.
Under the tax credit system, the last price elasticity is equivalent to the first one.
Since major observation units are observed when the tax credit system is implemented,
the last giving price is strongly correlated with the first one.
In other words, covariates between the last and first giving price is roughly equal to one.
In the first stage, the coefficient of first giving price is roughly 0.98 in any specifications. [^fstage]
Thus, our last price elasticity may be upper bound of true price elasticity.


[^fstage]: We do not show the first-stage results. Instead, we show the F-statistics of the instrument variable.


```{stata LastElasticity, results = "hide", eval = FALSE}
* first stage
xtreg log_lprice log_price log_pinc_all i.year, fe vce(cluster pid)

mat fstage = r(table)["b".."pvalue","log_price"]
mat fstage = fstage[1,1] \ fstage[3,1]^2
mat colnames fstage = M0
mat rownames fstage = ivcoef ivf

* second stage
xtivreg log_total_g log_pinc_all i.year (log_lprice = log_price), fe vce(cluster pid)

mat coeftab = r(table)["b".."pvalue", "log_lprice".."log_pinc_all"]
mat colnames coeftab = Loglprice_M0 Loginc_M0

mat stattab = e(N) \ e(r2)
mat colnames stattab = M0
mat rownames stattab = N r2

mat_rapp stattab : stattab fstage

* with covariates
local cov sqage i.year##i.educ i.year##i.gender i.year##i.living_area
local xvars 
local k = 1
foreach v of local cov {
	di "model `k'"
    
	*make set of covariates
	local xvars `xvars' `v'
	
	*first stage
	xtreg log_lprice log_price log_pinc_all i.year age `xvars', fe vce(cluster pid)
	
	mat fstage = r(table)["b".."pvalue","log_price"]
	mat fstage = fstage[1,1] \ fstage[3,1]^2
	mat colnames fstage = M`k'
	mat rownames fstage = ivcoef ivf
	
	*second stage
	xtivreg log_total_g log_pinc_all i.year age `xvars' (log_lprice = log_price), fe vce(cluster pid)
	
	mat coef = r(table)["b".."pvalue", "log_lprice".."log_pinc_all"]
	mat colnames coef = Loglprice_M`k' Loginc_M`k'

	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	mat_rapp stat : stat fstage
	
	*combined with previous results
	mat_capp coeftab : coeftab coef
	mat_capp stattab : stattab stat

	local k = `++k'
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/LastElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/LastElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{stata LastExtElasticity, results = "hide", eval = FALSE}
* first stage
xtreg log_lprice log_price log_pinc_all i.year, fe vce(cluster pid)

mat fstage = r(table)["b".."pvalue","log_price"]
mat fstage = fstage[1,1] \ fstage[3,1]^2
mat colnames fstage = M0
mat rownames fstage = ivcoef ivf

* second stage
xtivreg i_ext_giving log_pinc_all i.year (log_lprice = log_price), fe vce(cluster pid)

mat coeftab = r(table)["b".."pvalue", "log_lprice".."log_pinc_all"]
mat colnames coeftab = Loglprice_M0 Loginc_M0

mat stattab = e(N) \ e(r2)
mat colnames stattab = M0
mat rownames stattab = N r2

* price elasticity evaluated at mean
summarize i_ext_giving
local mu = r(mean)
lincom log_lprice*(1/`mu')

mat elas1 = r(estimate) \ r(se) \ (1 - normal(abs(r(estimate)/r(se))))*2
mat colnames elas1 = Loglprice_M0
mat rownames elas1 = e_b e_se e_pval

* price elasticity evaluated at mean
summarize i_ext_giving
local mu = r(mean)
lincom log_pinc_all*(1/`mu')

mat elas2 = r(estimate) \ r(se) \ (1 - normal(abs(r(estimate)/r(se))))*2
mat colnames elas2 = Loginc_M0
mat rownames elas2 = e_b e_se e_pval

mat_capp elas : elas1 elas2
mat_rapp coeftab : coeftab elas
mat_rapp stattab : stattab fstage

* with covariates
local cov sqage i.year##i.educ i.year##i.gender i.year##i.living_area
local xvars 
local k = 1
foreach v of local cov {
	di "model `k'"
    
	*make set of covariates
	local xvars `xvars' `v'
	
	*first stage
	xtreg log_lprice log_price log_pinc_all i.year age `xvars', fe vce(cluster pid)
	
	mat fstage = r(table)["b".."pvalue","log_price"]
	mat fstage = fstage[1,1] \ fstage[3,1]^2
	mat colnames fstage = M`k'
	mat rownames fstage = ivcoef ivf
	
	*second stage
	xtivreg i_ext_giving log_pinc_all i.year age `xvars' (log_lprice = log_price), fe vce(cluster pid)
	
	mat coef = r(table)["b".."pvalue", "log_lprice".."log_pinc_all"]
	mat colnames coef = Loglprice_M`k' Loginc_M`k'

	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	* price elasticity evaluated at mean
	summarize i_ext_giving
	local mu = r(mean)
	lincom log_lprice*(1/`mu')

	mat elas1 = r(estimate) \ r(se) \ (1 - normal(abs(r(estimate)/r(se))))*2
	mat colnames elas1 = Loglprice_M`k'
	mat rownames elas1 = e_b e_se e_pval

	* price elasticity evaluated at mean
	summarize i_ext_giving
	local mu = r(mean)
	lincom log_pinc_all*(1/`mu')

	mat elas2 = r(estimate) \ r(se) \ (1 - normal(abs(r(estimate)/r(se))))*2
	mat colnames elas2 = Loginc_M`k'
	mat rownames elas2 = e_b e_se e_pval

	mat_capp elas : elas1 elas2
	mat_rapp coef : coef elas
	mat_rapp stat : stat fstage
	
	*combined with previous results
	mat_capp coeftab : coeftab coef
	mat_capp stattab : stattab stat

	local k = `++k'
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/LastExtElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/LastExtElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{stata LastIntElasticity, results = "hide", eval = FALSE}
* first stage
xtreg log_lprice log_price log_pinc_all i.year if i_ext_giving == 1, fe vce(cluster pid)

mat fstage = r(table)["b".."pvalue","log_price"]
mat fstage = fstage[1,1] \ fstage[3,1]^2
mat colnames fstage = M0
mat rownames fstage = ivcoef ivf

* second stage
xtivreg log_total_g log_pinc_all i.year (log_lprice = log_price) if i_ext_giving == 1, fe vce(cluster pid)

mat coeftab = r(table)["b".."pvalue", "log_lprice".."log_pinc_all"]
mat colnames coeftab = Loglprice_M0 Loginc_M0

mat stattab = e(N) \ e(r2)
mat colnames stattab = M0
mat rownames stattab = N r2

mat_rapp stattab : stattab fstage

* with covariates
local cov sqage i.year##i.educ i.year##i.gender i.year##i.living_area
local xvars 
local k = 1
foreach v of local cov {
	di "model `k'"
    
	*make set of covariates
	local xvars `xvars' `v'
	
	*first stage
	xtreg log_lprice log_price log_pinc_all i.year age `xvars' if i_ext_giving == 1, fe vce(cluster pid)
	
	mat fstage = r(table)["b".."pvalue","log_price"]
	mat fstage = fstage[1,1] \ fstage[3,1]^2
	mat colnames fstage = M`k'
	mat rownames fstage = ivcoef ivf
	
	*second stage
	xtivreg log_total_g log_pinc_all i.year age `xvars' (log_lprice = log_price) if i_ext_giving == 1, fe vce(cluster pid)
	
	mat coef = r(table)["b".."pvalue", "log_lprice".."log_pinc_all"]
	mat colnames coef = Loglprice_M`k' Loginc_M`k'

	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	mat_rapp stat : stat fstage
	
	*combined with previous results
	mat_capp coeftab : coeftab coef
	mat_capp stattab : stattab stat

	local k = `++k'
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/LastIntElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/LastIntElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{r shapeLastElasticity}
coeftab <- list(
	overall = read.dta13("_assets/LastElasticityCoef.dta") %>% data.frame(),
	intensive = read.dta13("_assets/LastIntElasticityCoef.dta") %>% data.frame(),
	extensive = read.dta13("_assets/LastExtElasticityCoef.dta") %>% data.frame()
)

shape_coeftab <- coeftab %>% 
	purrr::map(function(x)
		x %>% 
			filter(!str_detect(xvar, "e_")) %>%
			pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
			pivot_wider(values_from = "value", names_from = "xvar") %>% 
			mutate(
				b = case_when(
					pvalue <= 0.01 ~ sprintf("%1.3f***", b),
					pvalue <= 0.05 ~ sprintf("%1.3f**", b),
					pvalue <= 0.1 ~ sprintf("%1.3f*", b),
					TRUE ~ sprintf("%1.3f", b)
				),
				se = sprintf("(%1.3f)", se)
			) %>% 
			select(-z, -pvalue) %>% 
			pivot_longer(cols = b:se, values_to = "value", names_to = "stat") %>% 
			pivot_wider(values_from = "value", names_from = "model") %>%
			mutate(
				vars = case_when(
					stat == "se" ~ "",
					vars == "Loglprice" ~ "ln(last giving price)",
					vars == "Loginc" ~ "ln(auunaul taxable income)"
				)
			) %>% 
			select(-stat)
	)

elastab <- coeftab$extensive %>% 
	filter(str_detect(xvar, "e_")) %>%
	pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
	pivot_wider(values_from = "value", names_from = "xvar") %>% 
	mutate(
		e_b = case_when(
			e_pval <= 0.01 ~ sprintf("%1.3f***", e_b),
			e_pval <= 0.05 ~ sprintf("%1.3f**", e_b),
			e_pval <= 0.1 ~ sprintf("%1.3f*", e_b),
			TRUE ~ sprintf("%1.3f", e_b)
		),
		e_se = sprintf("(%1.3f)", e_se)
	) %>% 
	select(-e_pval) %>% 
	pivot_longer(cols = e_b:e_se, values_to = "value", names_to = "stat") %>% 
	pivot_wider(values_from = "value", names_from = "model") %>%
	mutate(
		vars = case_when(
			stat == "e_se" ~ "",
			vars == "Loglprice" ~ "Implied last price elasiticity",
			vars == "Loginc" ~ "Implied income elasticity"
		)
	) %>% 
	select(-stat)

shape_coeftab$extensive <- rbind(shape_coeftab$extensive, elastab)

stattab <- list(
	overall = read.dta13("_assets/LastElasticityStat.dta") %>% data.frame(),
	intensive = read.dta13("_assets/LastIntElasticityStat.dta") %>% data.frame(),
	extensive = read.dta13("_assets/LastExtElasticityStat.dta") %>% data.frame()
) %>% 
purrr::map(function(x) 
	x %>% mutate_at(
		vars(-xvar),
		list(~case_when(xvar == "N" ~ sprintf("%1.0f", .), TRUE ~ sprintf("%1.2f", .)))
	) %>% 
	mutate(xvar = recode(xvar, "r2" = "R-sq", "ivf" = "F-statistics of IV", .default = xvar)) %>% 
	rename(vars = xvar) %>% 
	filter(vars != "R-sq" & vars != "ivcoef") %>% 
	.[c(2,1),]
)

addline <- cbind(
	vars = c("Individual FE", "Time FE", "Age", "Year X Education", "Year X Gender", "Year X Resident Area"),
	M0 = c(rep("Y", 2), rep("N", 4)),
	M1 = c(rep("Y", 3), rep("N", 3)),
	M2 = c(rep("Y", 4), rep("N", 2)),
	M3 = c(rep("Y", 5), rep("N", 1)),
	M4 = rep("Y", 6)
)

tabular <- c("overall", "intensive", "extensive") %>% 
	purrr::map(function(x) rbind(shape_coeftab[[x]], addline) %>% rbind(stattab[[x]]))

alltab <- tabular[[1]]
intexttab <- rbind(tabular[[2]][-(5:10),], tabular[[3]])
```

<!-- Slide
## Robustness Check 1: Result

Overall last price elasticity increases twofold.

```{r kableLastElasticity1Slide, include = TRUE, eval = FALSE}
knitr::kable(
	alltab[-c(5:6, 11),],
    format = "latex",
    caption = "Last Price Elasticity: Panel IV",
    col.names = c("", "(1)", "(2)", "(3)", "(4)", "(5)"),
    row.names = FALSE,
    align = "lccccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 7) #%>% 
#footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. The instumental variable is the first giving price in year $t$. When controlling age, we alson include its squared term.", threeparttable = TRUE, escape = FALSE)
```

## Robustness Check 1: Intensive Margin

The intensive-margin last price elasticity lies within the range of the first price elasticity.

```{r kableLastElasticity2Slide1, include = TRUE, eval = FALSE}
knitr::kable(
    rbind(intexttab[1:4,], intexttab[17:20,]) %>% rbind(intexttab[6,]),
    format = "latex",
    caption = "Intensive-Margin Last Price Elasticity: Panel IV",
    col.names = c("", "(1)", "(2)", "(3)", "(4)", "(5)"),
    row.names = FALSE,
    align = "lccccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 7)
```

## Robustness Check 1: Extensive Margin

The extensive-margin last price elasticity at sample mean is roughly -3\%.

```{r kableLastElasticity2Slide2, include = TRUE, eval = FALSE}
knitr::kable(
    rbind(intexttab[11:14,], intexttab[17:20,]) %>% rbind(intexttab[22,]),
    format = "latex",
    caption = "Extensive-Margin Last Price Elasticity: Panel IV",
    col.names = c("", "(1)", "(2)", "(3)", "(4)", "(5)"),
    row.names = FALSE,
    align = "lccccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 7)
```
--->

\color{black} 
The last price elasticity is in line with our first conclusion.
Table \@ref(tab:kableLastElasticity1) shows overall last price elasticity.
Compared to the main results, the last price elasticity is more elastic.
The aboslute value of estimated coefficient is larger than 2.4,
which is statistically significant different from zero.
This implies that 1\% increase of last price decreases charitable contributions by 2.4\% or more.
Table \@ref(tab:kableLastElasticity2) shows the intensive-margin and extensive-margin last price elasticity.
In the first panel, 
the intensive-margin last price elasticity is similar value to the main results.
Its abolute value lies between 0.89 and 1.2.
These results are statistically different from zero.
In the second panel,
the coefficient of logged last price, which represents the lower bound of last price elasticity,
lies between -0.63 and -0.59.
The implied last price elasticity evalueated at the sample mean of $D_{it}$ is roughly -3.
These results are statistically significant different from zero,
and more elastic than the first price elasticity.

```{r kableLastElasticity1, include = TRUE}
knitr::kable(
	alltab,
    #alltab[-c(5:6, 11),], slide
    format = "latex",
    caption = "Last Price Elasticity: Panel IV",
    col.names = c("", "(1)", "(2)", "(3)", "(4)", "(5)"),
    row.names = FALSE,
    align = "lccccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 7) %>% 
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. The instumental variable is the first giving price in year $t$. When controlling age, we alson include its squared term.", threeparttable = TRUE, escape = FALSE)
```

```{r kableLastElasticity2, include = TRUE}
knitr::kable(
    intexttab,
    format = "latex",
    caption = "Intensive- and Extensive-Margin Last Price Elasticity: Panel IV",
    col.names = c("", "(1)", "(2)", "(3)", "(4)", "(5)"),
    row.names = FALSE,
    align = "lccccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 7) %>% 
pack_rows("Intensive-Margin Elasticity", 1, 6) %>% 
pack_rows("Extensive-Margin Elasticity", 7, 22) %>% 
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. The instumental variable is the first giving price in year $t$. When controlling age, we alson include its squared term. The implied extensive-marign price elasticity is evaluated at the sample mean of $D_{ijt}$.", threeparttable = TRUE, escape = FALSE)
```


<!--- Slide
## Robust Check 2

Second potential concern: Price change due to the change of income
    
- Since the giving price under the tax deduction depends on the change of income, the *within* variation of giving price may be endogenous.
- To resolve this concern, we used the data (i) from 2013 to 2018 or (ii) from 2013 to 2014, and estimated the fixed effect model.
    - By this restriction, the *within* price variation of giving price is completely exgonenous.
--->

\color{blue}
In the second robustness check, we try to control the manipulation of giving price by adjusting income level using two datasets whose ranges are (i) from 2013 to 2018 and (ii) from 2013 to 2014. Under the tax deduction system, the giving price can be manipulated by income level, though it cannot under the tax credit system. Therefore, if we use the dataset which contains data under the the tax deduction system, the estimator may capture the effect of price change which is caused not by tax reform but by price manipulation by income adjustment. To address this issue, we use dataset in which the time range under the tax deduction system is shorter than the baseline analysis. By doing this exercise, we try to suppress the effect which comes from the price change due to the change of income.(この点ですが、普通はむしろTime spanを長くして、TransitonaryなEffectとPersistentなEffectを分けて議論するのが普通だと思います。原稿のバージョンでは意図をくんでごまかして書いています。)

```{stata ShortElasticity, results = "hide", eval = FALSE}
* M0: year >= 2013 without cov
xtreg log_total_g log_price log_pinc_all i.year if year >= 2013, fe vce(cluster pid)

mat coeftab0 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab0 = Logprice_M0 Loginc_M0

mat stattab0 = e(N) \ e(r2)
mat colnames stattab0 = M0
mat rownames stattab0 = N r2

* M1: year >= 2013 with cov
xtreg log_total_g log_price log_pinc_all i.year age sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
	if year >= 2013, fe vce(cluster pid)

mat coeftab1 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab1 = Logprice_M1 Loginc_M1

mat stattab1 = e(N) \ e(r2)
mat colnames stattab1 = M1
mat rownames stattab1 = N r2

* M2: year == 2013 | 2014 without cov
xtreg log_total_g log_price log_pinc_all i.year if year == 2013 | year == 2014, fe vce(cluster pid)

mat coeftab2 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab2 = Logprice_M2 Loginc_M2

mat stattab2 = e(N) \ e(r2)
mat colnames stattab2 = M2
mat rownames stattab2 = N r2

* M3: year == 2013 | 2014 with cov
xtreg log_total_g log_price log_pinc_all i.year age sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
	if year == 2013 | year == 2014, fe vce(cluster pid)

mat coeftab3 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab3 = Logprice_M3 Loginc_M3

mat stattab3 = e(N) \ e(r2)
mat colnames stattab3 = M3
mat rownames stattab3 = N r2

mat_capp coeftab : coeftab0 coeftab1
mat_capp coeftab : coeftab coeftab2
mat_capp coeftab : coeftab coeftab3

mat_capp stattab : stattab0 stattab1
mat_capp stattab : stattab stattab2
mat_capp stattab : stattab stattab3

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/ShortElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/ShortElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{stata ShortIntElasticity, results = "hide", eval = FALSE}
* M0: year >= 2013 without cov
xtreg log_total_g log_price log_pinc_all i.year if year >= 2013 & i_ext_giving == 1, fe vce(cluster pid)

mat coeftab0 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab0 = Logprice_M0 Loginc_M0

mat stattab0 = e(N) \ e(r2)
mat colnames stattab0 = M0
mat rownames stattab0 = N r2

* M1: year >= 2013 with cov
xtreg log_total_g log_price log_pinc_all i.year age sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
	if year >= 2013 & i_ext_giving == 1, fe vce(cluster pid)

mat coeftab1 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab1 = Logprice_M1 Loginc_M1

mat stattab1 = e(N) \ e(r2)
mat colnames stattab1 = M1
mat rownames stattab1 = N r2

* M2: year == 2013 | 2014 without cov
xtreg log_total_g log_price log_pinc_all i.year if (year == 2013 | year == 2014) & i_ext_giving == 1, fe vce(cluster pid)

mat coeftab2 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab2 = Logprice_M2 Loginc_M2

mat stattab2 = e(N) \ e(r2)
mat colnames stattab2 = M2
mat rownames stattab2 = N r2

* M3: year == 2013 | 2014 with cov
xtreg log_total_g log_price log_pinc_all i.year age sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
	if (year == 2013 | year == 2014) & i_ext_giving == 1, fe vce(cluster pid)

mat coeftab3 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab3 = Logprice_M3 Loginc_M3

mat stattab3 = e(N) \ e(r2)
mat colnames stattab3 = M3
mat rownames stattab3 = N r2

mat_capp coeftab : coeftab0 coeftab1
mat_capp coeftab : coeftab coeftab2
mat_capp coeftab : coeftab coeftab3

mat_capp stattab : stattab0 stattab1
mat_capp stattab : stattab stattab2
mat_capp stattab : stattab stattab3

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/ShortIntElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/ShortIntElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{stata ShortExtElasticity, results = "hide", eval = FALSE}
** M0: year >= 2013 without cov
xtreg i_ext_giving log_price log_pinc_all i.year if year >= 2013, fe vce(cluster pid)

mat coeftab0 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab0 = Logprice_M0 Loginc_M0

mat stattab0 = e(N) \ e(r2)
mat colnames stattab0 = M0
mat rownames stattab0 = N r2

* price elasticity evaluated at mean
summarize i_ext_giving if year >= 2013
local mu = r(mean)
lincom log_price*(1/`mu')

mat elas1 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas1 = Logprice_M0
mat rownames elas1 = e_b e_se e_pval

* price elasticity evaluated at mean
summarize i_ext_giving if year >= 2013
local mu = r(mean)
lincom log_pinc_all*(1/`mu')

mat elas2 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas2 = Loginc_M0
mat rownames elas2 = e_b e_se e_pval

mat_capp elas : elas1 elas2
mat_rapp coeftab0 : coeftab0 elas

** M1: year >= 2013 with cov
xtreg i_ext_giving log_price log_pinc_all i.year age sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
	if year >= 2013, fe vce(cluster pid)

mat coeftab1 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab1 = Logprice_M1 Loginc_M1

mat stattab1 = e(N) \ e(r2)
mat colnames stattab1 = M1
mat rownames stattab1 = N r2

* price elasticity evaluated at mean
summarize i_ext_giving if year >= 2013
local mu = r(mean)
lincom log_price*(1/`mu')

mat elas1 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas1 = Logprice_M1
mat rownames elas1 = e_b e_se e_pval

* price elasticity evaluated at mean
summarize i_ext_giving if year >= 2013
local mu = r(mean)
lincom log_pinc_all*(1/`mu')

mat elas2 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas2 = Loginc_M1
mat rownames elas2 = e_b e_se e_pval

mat_capp elas : elas1 elas2
mat_rapp coeftab1 : coeftab1 elas

** M2: year == 2013 | 2014 without cov
xtreg i_ext_giving log_price log_pinc_all i.year if year == 2013 | year == 2014, fe vce(cluster pid)

mat coeftab2 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab2 = Logprice_M2 Loginc_M2

mat stattab2 = e(N) \ e(r2)
mat colnames stattab2 = M2
mat rownames stattab2 = N r2

* price elasticity evaluated at mean
summarize i_ext_giving if year == 2013 | year == 2014
local mu = r(mean)
lincom log_price*(1/`mu')

mat elas1 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas1 = Logprice_M2
mat rownames elas1 = e_b e_se e_pval

* price elasticity evaluated at mean
summarize i_ext_giving if year == 2013 | year == 2014
local mu = r(mean)
lincom log_pinc_all*(1/`mu')

mat elas2 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas2 = Loginc_M2
mat rownames elas2 = e_b e_se e_pval

mat_capp elas : elas1 elas2
mat_rapp coeftab2 : coeftab2 elas

** M3: year == 2013 | 2014 with cov
xtreg i_ext_giving log_price log_pinc_all i.year age sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
	if year == 2013 | year == 2014, fe vce(cluster pid)

mat coeftab3 = r(table)["b".."pvalue", "log_price".."log_pinc_all"]
mat colnames coeftab3 = Logprice_M3 Loginc_M3

mat stattab3 = e(N) \ e(r2)
mat colnames stattab3 = M3
mat rownames stattab3 = N r2

* price elasticity evaluated at mean
summarize i_ext_giving if year == 2013 | year == 2014
local mu = r(mean)
lincom log_price*(1/`mu')

mat elas1 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas1 = Logprice_M3
mat rownames elas1 = e_b e_se e_pval

* price elasticity evaluated at mean
summarize i_ext_giving if year == 2013 | year == 2014
local mu = r(mean)
lincom log_pinc_all*(1/`mu')

mat elas2 = r(estimate) \ r(se) \ ttail(r(df), abs(r(estimate)/r(se)))*2
mat colnames elas2 = Loginc_M3
mat rownames elas2 = e_b e_se e_pval

mat_capp elas : elas1 elas2
mat_rapp coeftab3 : coeftab3 elas

mat_capp coeftab : coeftab0 coeftab1
mat_capp coeftab : coeftab coeftab2
mat_capp coeftab : coeftab coeftab3

mat_capp stattab : stattab0 stattab1
mat_capp stattab : stattab stattab2
mat_capp stattab : stattab stattab3

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/ShortExtElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/ShortExtElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{r shapeShortElasticity}
coeftab <- list(
	overall = read.dta13("_assets/ShortElasticityCoef.dta") %>% data.frame(),
	intensive = read.dta13("_assets/ShortIntElasticityCoef.dta") %>% data.frame(),
	extensive = read.dta13("_assets/ShortExtElasticityCoef.dta") %>% data.frame()
)

shape_coeftab <- coeftab %>% 
	purrr::map(function(x)
		x %>% 
			filter(!str_detect(xvar, "e_")) %>%
			pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
			pivot_wider(values_from = "value", names_from = "xvar") %>% 
			mutate(
				b = case_when(
					pvalue <= 0.01 ~ sprintf("%1.3f***", b),
					pvalue <= 0.05 ~ sprintf("%1.3f**", b),
					pvalue <= 0.1 ~ sprintf("%1.3f*", b),
					TRUE ~ sprintf("%1.3f", b)
				),
				se = sprintf("(%1.3f)", se)
			) %>% 
			select(-t, -pvalue) %>% 
			pivot_longer(cols = b:se, values_to = "value", names_to = "stat") %>% 
			pivot_wider(values_from = "value", names_from = "model") %>%
			mutate(
				vars = case_when(
					stat == "se" ~ "",
					vars == "Logprice" ~ "ln(giving price)",
					vars == "Loginc" ~ "ln(auunaul taxable income)"
				)
			) %>% 
			select(-stat)
	)

elastab <- coeftab$extensive %>% 
	filter(str_detect(xvar, "e_")) %>%
	pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
	pivot_wider(values_from = "value", names_from = "xvar") %>% 
	mutate(
		e_b = case_when(
			e_pval <= 0.01 ~ sprintf("%1.3f***", e_b),
			e_pval <= 0.05 ~ sprintf("%1.3f**", e_b),
			e_pval <= 0.1 ~ sprintf("%1.3f*", e_b),
			TRUE ~ sprintf("%1.3f", e_b)
		),
		e_se = sprintf("(%1.3f)", e_se)
	) %>% 
	select(-e_pval) %>% 
	pivot_longer(cols = e_b:e_se, values_to = "value", names_to = "stat") %>% 
	pivot_wider(values_from = "value", names_from = "model") %>%
	mutate(
		vars = case_when(
			stat == "e_se" ~ "",
			vars == "Logprice" ~ "Implied price elasiticity",
			vars == "Loginc" ~ "Implied income elasticity"
		)
	) %>% 
	select(-stat)

shape_coeftab$extensive <- rbind(shape_coeftab$extensive, elastab)

stattab <- list(
	overall = read.dta13("_assets/ShortElasticityStat.dta") %>% data.frame(),
	intensive = read.dta13("_assets/ShortIntElasticityStat.dta") %>% data.frame(),
	extensive = read.dta13("_assets/ShortExtElasticityStat.dta") %>% data.frame()
) %>% 
purrr::map(function(x) 
	x %>% mutate_at(
		vars(-xvar),
		list(~case_when(xvar == "N" ~ sprintf("%1.0f", .), TRUE ~ sprintf("%1.3f", .)))
	) %>% 
	mutate(xvar = recode(xvar, "r" = "R-sq", "r2" = "R-sq", .default = xvar)) %>% 
	rename(vars = xvar)
)

addline <- cbind(
	vars = c("Individual FE", "Time FE", "Other Controls"),
	M0 = c(rep("Y", 2), "N"),
	M1 = rep("Y", 3),
	M2 = c(rep("Y", 2), "N"),
	M3 = rep("Y", 3)
)

tabular <- c("overall", "intensive", "extensive") %>% 
	purrr::map(function(x) rbind(shape_coeftab[[x]], addline) %>% rbind(stattab[[x]]))

alltab <- tabular[[1]]
intexttab <- rbind(tabular[[2]][-(5:7),], tabular[[3]])
```

<!--- Slide
## Robustness Check 2: Result

Overall price elasticity is -1 ~ -1.7\%.

```{r kableShortElasticity1Slide, include=TRUE, eval = FALSE}
knitr::kable(
    alltab[-c(5, 6, 9),],
    format = "latex",
    caption = "Elasticity with Short-Period Data",
    col.names = c("", "(1)", "(2)", "(3)", "(4)"),
    row.names = FALSE,
    align = "lcccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 8) %>% 
add_header_above(c(" " = 1, "After 2012" = 2, "2013 and 2014" = 2), escape = FALSE) #%>%
#footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. Other controls are age (its squared value), the interaction between year dummies and education dummies, the interaction between year dummies and gender dummies, and the interaction between year dummies and resident area.", threeparttable = TRUE, escape = FALSE)
```


## Robustness Check 2: Intensive Marign

The intensive-margin price elasticity is -0.6 ~ -1\%.
In column (3), the price elasticity is statistically insignificant.

```{r kableShortElasticity2Slide1, include=TRUE, eval = FALSE}
knitr::kable(
    rbind(intexttab[1:4,], intexttab[17,]) %>% rbind(intexttab[5,]),
    format = "latex",
    caption = "Intensive-Margin Elasticity with Short-Period Data",
    col.names = c("", "(1)", "(2)", "(3)", "(4)"),
    row.names = FALSE,
    align = "lcccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 8) %>% 
add_header_above(c(" " = 1, "After 2012" = 2, "2013 and 2014" = 2), escape = FALSE) 
```

## Robustness Check 2: Extensive Marign

The extensive-margin price elasticity at sample mean is -1 ~ -2\%.

```{r kableShortElasticity2Slide2, include=TRUE, eval = FALSE}
knitr::kable(
    rbind(intexttab[11:14,], intexttab[17:18,]),
    format = "latex",
    caption = "Extensive-Margin Elasticity with Short-Period Data",
    col.names = c("", "(1)", "(2)", "(3)", "(4)"),
    row.names = FALSE,
    align = "lcccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 8) %>% 
add_header_above(c(" " = 1, "After 2012" = 2, "2013 and 2014" = 2), escape = FALSE) 
```
--->

\color{black}
Table \@ref(tab:kableShortElasticity1) shows the overall first giving price elasticity.
When we use data from 2013 to 2018, the estimated price elasticity is similar value to the main results.
On the other hand,
when we use data from 2013 to 2014, the estimated price elasticity is more elastic than the main results.
The estimated absolute value is roughly -1.7 when we control covariates and its interaction with year dummies.
This value is statistically significant different from zero.

```{r kableShortElasticity1, include=TRUE}
knitr::kable(
    alltab,
    format = "latex",
    caption = "Elasticity with Short-Period Data",
    col.names = c("", "(1)", "(2)", "(3)", "(4)"),
    row.names = FALSE,
    align = "lcccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 7) %>% 
add_header_above(c(" " = 1, "After 2012" = 2, "2013 and 2014" = 2), escape = FALSE) %>%
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. Other controls are age (its squared value), the interaction between year dummies and education dummies, the interaction between year dummies and gender dummies, and the interaction between year dummies and resident area.", threeparttable = TRUE, escape = FALSE)
```

Table \@ref(tab:kableShortElasticity2) shows the intensive-margin and the extensive-margin first price elasticity.
The first panel shows the intensive-margin elasticity.
When we use data from 2012 to 2018, the intensive-margin price elasiticity is similar to the main results,
which is statistically significant from zero.
However, when we use data from 2013 to 2014 and include only individual and time fixed effects,
the estimated coefficient is statistically insignificant different from zero.
By controlling covariates and its interaction with year dummies,
the intensive-margin price elasticity is -0.712, which is statistically significant.
The second panel shows the extensive-margin elasticity.
When we use data from 2012 to 2018, the extensive-margin price elasticity is similar to the main results,
which is statistically significant.
When we use data from 2013 to 2014, the extensive-margin price elasticity is more elastic than the main results.
Its absolute value is roughly -2, which is statistically significant.

```{r kableShortElasticity2, include=TRUE}
knitr::kable(
    intexttab,
    format = "latex",
    caption = "Intensive- and Extensive-Margin Elasticity with Short-Period Data",
    col.names = c("", "(1)", "(2)", "(3)", "(4)"),
    row.names = FALSE,
    align = "lcccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 7) %>% 
pack_rows("Intensive-Margin Elasticity", 1, 6) %>% 
pack_rows("Extensive-Margin Elasticity", 7, 19) %>% 
add_header_above(c(" " = 1, "After 2012" = 2, "2013 and 2014" = 2), escape = FALSE) %>%
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. Other controls are age (its squared value), the interaction between year dummies and education dummies, the interaction between year dummies and gender dummies, and the interaction between year dummies and resident area. The implied extensive-marign price elasticity is evaluated at the sample mean of $D_{ijt}$.", threeparttable = TRUE, escape = FALSE)
```

<!--- Slide
## Robustness Check 3

Second potential concerns: the change of price due to the change of income

- To exclude this potential concerns, previous identification strategy uses the 2014 tax reform.
- We can also rule out this problem, using the change in the first giving price.
    - The change in the first giving price is $\ln(p_{it}(y_{it-k} - g_{it-k})/p_{it-k}(y_{it-k} - g_{it-k}))$ where $g_{it-k} = 0$.
    - Since we fix the income $y_{it-k}$, this variation comes from the tax reform.

## Robustness Check 3 (Cont'd)

Our estimation equation is 
$$\Delta^k \ln g_{it} = \delta \Delta^k \ln p_{it} + \gamma \Delta^k \ln y_{it} + \Delta^k X_{it} \beta + \mu_i + \iota_t + v_{it},$$
where $\Delta^k Y_{it} = Y_{it} - Y_{it-k}$.

- Note that we cannot estimation the extensive-margin elasticity since it is hard to interapt this estimation equation when we use $\Delta^k D_{it}$ as an outcome.
- We estimate this model for $k = 1, 2, 3$.
--->

The third robustness check is to estimate the $k$-th difference model. The tax reform may have impacts on the giving price in two ways: one is direct giving price change by tax reform and the other is indirect change via wealth effect, which is induced by tax reform. Thus, to isolate the direct effect of the tax reform, we use the information of income level $k$ years before.
Concreately speaking, we estimate the $k$-th difference model formulated as follows:
$$
\Delta^k \ln g_{it} = \delta \Delta^k \ln p_{it} + \gamma \Delta^k \ln y_{it} + \Delta^k X_{it} \beta + \mu_i + \iota_t + v_{it},
$$
where $\Delta^k \ln g_{it} = \ln g_{it} - \ln g_{it-k}$ and $\Delta^k \ln y_{it} = \ln y_{it} - y_{it-k}$.

\color{blue}
The variable $\Delta^k p_{it}$ is defined as $\Delta^k p_{it} \equiv \ln p_{it}(y_{it-k}) - \ln p_{it}(y_{it-k})$.[^Deltacredit]
The variation of this variable comes from the tax reform because we fix the annual income at year $t - k$.
Therefore, we can interpret this coefficient as the giving price elasticity due to the tax reform.
In particular, the estimated $\delta$ implies that 1\% increase of the change of giving price leads to $\hat{\delta}$\% increase of the change of charitable giving.
Note that we do not estimate the extensive-margin elasticity because it is hard to interpret this estimation equation when we use $\Delta^k D_{it}$ as an outcome variable.

[^Deltacredit]: Under the tax credit system, the giving price does not depend on income $y_{it-k}$. If the tax credit system is impelemted in year $t$ and $t-k$, then the value of $\Delta^k p_{it}$ takes zero.


```{stata kDiffElasticity, results = "hide", eval = FALSE}
forvalues k = 1(1)3 {
    
	di "lag = `k'"
	
	* panel regression
	xtreg log_diff`k'g log_iv`k'price log_diff`k'I diff`k'_age diff`k'_sqage i.year##i.educ i.year##i.gender i.year##i.living_area, ///
		fe vce(cluster pid)
	
	* result of panel regression
	mat coef = r(table)["b".."pvalue","log_iv`k'price".."log_diff`k'I"]
	mat colnames coef = Logdiffprice_M`k' Logdiffinc_M`k'
	
	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	if `k' == 1 {
	    mat coeftab = coef
		mat stattab = stat
	}
	else {
	    mat_capp coeftab : coeftab coef
		mat_capp stattab : stattab stat
	}
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/kDiffElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/kDiffElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{stata kDiffIntElasticity, results = "hide", eval = FALSE}
forvalues k = 1(1)3 {
    
	di "lag = `k'"
	
	* panel regression
	xtreg log_diff`k'g log_iv`k'price log_diff`k'I diff`k'_age diff`k'_sqage i.year##i.educ i.year##i.gender i.year##i.living_area ///
		if i_ext_giving == 1, fe vce(cluster pid)
	
	* result of panel regression
	mat coef = r(table)["b".."pvalue","log_iv`k'price".."log_diff`k'I"]
	mat colnames coef = Logdiffprice_M`k' Logdiffinc_M`k'
	
	mat stat = e(N) \ e(r2)
	mat colnames stat = M`k'
	mat rownames stat = N r2
	
	if `k' == 1 {
	    mat coeftab = coef
		mat stattab = stat
	}
	else {
	    mat_capp coeftab : coeftab coef
		mat_capp stattab : stattab stat
	}
}

mat list coeftab
mat list stattab

xsvmat coeftab, saving(_assets/kDiffIntElasticityCoef.dta, replace) rownames(xvar) names(col)
xsvmat stattab, saving(_assets/kDiffIntElasticityStat.dta, replace) rownames(xvar) names(col)
```

```{r shapekDiffElasticity}
coeftab <- list(
	overall = read.dta13("_assets/kDiffElasticityCoef.dta") %>% data.frame(),
	intensive = read.dta13("_assets/kDiffIntElasticityCoef.dta") %>% data.frame()
)

shape_coeftab <- coeftab %>% 
	purrr::map(function(x)
		x %>% 
			filter(!str_detect(xvar, "e_")) %>%
			pivot_longer(-xvar, values_to = "value", names_to = c("vars", "model"), names_sep = "_") %>% 
			pivot_wider(values_from = "value", names_from = "xvar") %>% 
			mutate(
				b = case_when(
					pvalue <= 0.01 ~ sprintf("%1.3f***", b),
					pvalue <= 0.05 ~ sprintf("%1.3f**", b),
					pvalue <= 0.1 ~ sprintf("%1.3f*", b),
					TRUE ~ sprintf("%1.3f", b)
				),
				se = sprintf("(%1.3f)", se)
			) %>% 
			select(-t, -pvalue) %>% 
			pivot_longer(cols = b:se, values_to = "value", names_to = "stat") %>% 
			pivot_wider(values_from = "value", names_from = "model") %>%
			mutate(
				vars = case_when(
					stat == "se" ~ "",
					vars == "Logdiffprice" ~ "Lagged difference of first price (log)",
					vars == "Logdiffinc" ~ "Lagged difference of annual income (log)"
				)
			) %>% 
			select(-stat)
	)

stattab <- list(
	overall = read.dta13("_assets/kDiffElasticityStat.dta") %>% data.frame(),
	intensive = read.dta13("_assets/kDiffIntElasticityStat.dta") %>% data.frame()
) %>% 
purrr::map(function(x) 
	x %>% mutate_at(
		vars(-xvar),
		list(~case_when(xvar == "N" ~ sprintf("%1.0f", .), TRUE ~ sprintf("%1.3f", .)))
	) %>% 
	mutate(xvar = recode(xvar, "r" = "R-sq", "r2" = "R-sq", .default = xvar)) %>% 
	rename(vars = xvar)
)

addline <- cbind(
	vars = c("Individual FE", "Time FE", "Other Controls"),
	M1 = rep("Y", 3),
	M2 = rep("Y", 3),
	M3 = rep("Y", 3)
)

tabular <- c("overall", "intensive") %>% 
	purrr::map(function(x) rbind(shape_coeftab[[x]], addline) %>% rbind(stattab[[x]]))

alltab <- rbind(tabular[[1]][-(5:7),], tabular[[2]])
```

<!--- Slide
## Robustness Check 3: Overall Elasticity

Overall price elasticity is rougnly -2\%.

```{r kablekDiffElasticitySlide1, include=TRUE, eval=FALSE}
knitr::kable(
    alltab[1:5,],
    format = "latex",
    caption = "Overall Elasticity: $k$-difference model",
    col.names = c("", "(1)", "(2)", "(3)"),
    row.names = FALSE,
    align = "lccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 8) %>% 
add_header_above(c("lag $k$" = 1, "$k = 1$" = 1, "$k = 2$" = 1, "$k = 3$" = 1), escape = FALSE) 
```

## Robustness Check 3: Intensive-Margin Elasticity

The intensive-margin price elasticity is rougnly -2\%.

```{r kablekDiffElasticitySlide2, include=TRUE, eval=FALSE}
knitr::kable(
    rbind(alltab[7:10,], alltab[14,]),
    format = "latex",
    caption = "Intensive-Margin Elasticity: $k$-difference model",
    col.names = c("", "(1)", "(2)", "(3)"),
    row.names = FALSE,
    align = "lccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 8) %>% 
add_header_above(c("lag $k$" = 1, "$k = 1$" = 1, "$k = 2$" = 1, "$k = 3$" = 1), escape = FALSE) 
```
--->

\color{black}
Table \@ref(tab:kablekDiffElasticity) shows results of $k$-th difference model.
The first panel shows the overall elasticity.
When we take the one year lag ($k = 1$), the overall price elasticity is roughly -1.9,
which is statistically significant.
This elasticity slightly varies when we take the two or more year lag ($k > 1$).
The overall price elasticity lies between -2.1 and -1.7, which is statistically significant.
This implies that the overall price elasticity obtained by this model is more elastic than the main results.
The second panel shows the intensive-margin elasticity.
When we take the one year lag ($k = 1$), the intensive-margin price elasticity is roughly -1.8,
which is statistically significant.
The absolute value of the price elasticity is more than 2
when we take two or more year lag ($k > 1$).
Thus, contrary to our first conclusion,
this model implies that the amount of donations is sensitive to the giving price once we decide to donate.

```{r kablekDiffElasticity, include=TRUE}
knitr::kable(
    alltab,
    format = "latex",
    caption = "Estimation of Elasticity: $k$-difference model",
    col.names = c("", "(1)", "(2)", "(3)"),
    row.names = FALSE,
    align = "lccc", 
    booktabs = TRUE, escape = TRUE, linesep = ""
) %>% 
kable_styling(font_size = 7) %>% 
pack_rows("Overall Elasticity", 1, 6) %>% 
pack_rows("Intensive-Margin Elasticity", 7, 15) %>% 
add_header_above(c("lag $k$" = 1, "$k = 1$" = 1, "$k = 2$" = 1, "$k = 3$" = 1), escape = FALSE) %>%
footnote(general_title = "", general = "Notes: $^{*}$ $p < 0.1$, $^{**}$ $p < 0.05$, $^{***}$ $p < 0.01$. Standard errors are clustered at individual level. The lagged difference of first price (log) is $\\\\ln(\\\\text{Price}^k_{ijt}) - \\\\ln(\\\\text{Price}_{ij(t-k)})$, where $\\\\text{Price}^k_{ijt}$ calculates the giving price under the tax system in year $t$, using annual taxable income in year $t-k$, $\\\\text{Income}_{ij(t-k)}$. The lagged of annual income (log) is $\\\\ln(\\\\text{Income}_{ijt}) - \\\\ln(\\\\text{Income}_{ij(t-k)})$. Other controls are lagged difference of age, lagged difference of squared age, the interaction between year dummies and education dummies, the interaction between year dummies and gender dummies, and the interaction between year dummies and resident area.", threeparttable = TRUE, escape = FALSE)
```


In summary, the result shows that the size of estimated elasticity may vary depending on the estimation methods. This may be because the sample size is small compared to the extant research. However, our three robustness checks are in line with the baseline result, which shows that the price elasticity of intensive margin is less elastic than one of extensive margin. Thus, the obtained results suggest that the decision to donate is sensitive to the giving price, though the amount of donations is insensitive to the giving price once they decide to donate. 
\color{blue}XXX\color{black}.
